<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‘í’ˆ ìƒì„¸ - CRAFIQ</title>
    <link rel="stylesheet" as="style" crossOrigin
        href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module" src="js/turbo-router.js"></script>

    <style>
        /* Immersive Hero */
        .detail-hero {
            position: relative;
            width: 100%;
            height: 45vh;
            min-height: 380px;
            overflow: hidden;
            display: flex;
            align-items: flex-end;
        }

        .detail-bg {
            position: absolute;
            inset: 0;
            background-size: cover;
            background-position: center;
            filter: blur(40px) brightness(0.4);
            transform: scale(1.2);
            z-index: 1;
        }

        .detail-gradient {
            position: absolute;
            inset: 0;
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0.2), #121212);
            z-index: 2;
        }

        .detail-content {
            position: relative;
            z-index: 10;
            width: 100%;
            max-width: 1080px;
            margin: 0 auto;
            padding: 0 20px 40px;
            display: flex;
            gap: 32px;
            align-items: flex-end;
        }

        .detail-cover-img {
            width: 180px;
            aspect-ratio: 2/3;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            object-fit: cover;
            flex-shrink: 0;
        }

        .detail-info {
            flex: 1;
            color: white;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            margin-bottom: 10px;
        }

        .tag-badge {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            color: #fff;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 12px;
            margin-right: 6px;
        }

        .detail-title {
            font-size: 32px;
            font-weight: 800;
            line-height: 1.2;
            margin-bottom: 12px;
        }

        .detail-author {
            font-size: 15px;
            opacity: 0.9;
            margin-bottom: 16px;
        }

        .detail-metrics {
            display: flex;
            gap: 16px;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
        }

        /* Body Content */
        .detail-body {
            background: #fff;
            min-height: 500px;
            padding: 40px 20px 100px;
        }

        .container {
            max-width: 1080px;
            margin: 0 auto;
        }

        /* Buttons */
        .action-area {
            display: flex;
            gap: 12px;
            margin-bottom: 40px;
        }

        .btn-play-lg {
            flex: 1;
            height: 56px;
            background: #1f8ce6;
            color: white;
            font-size: 16px;
            font-weight: 700;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: 0.2s;
        }

        .btn-play-lg:hover {
            background: #1579c9;
        }

        .btn-sub {
            width: 56px;
            height: 56px;
            background: #f5f5f5;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #333;
        }

        .synopsis {
            font-size: 15px;
            line-height: 1.7;
            color: #444;
            margin-bottom: 50px;
            white-space: pre-wrap;
        }

        /* Chapter List */
        .chapter-list {
            border-top: 1px solid #eee;
        }

        .chapter-item {
            display: flex;
            align-items: center;
            padding: 16px 8px;
            border-bottom: 1px solid #f5f5f5;
            cursor: pointer;
            transition: 0.2s;
        }

        .chapter-item:hover {
            background: #fafafa;
        }

        .ch-thumb {
            width: 80px;
            height: 50px;
            background: #eee;
            border-radius: 4px;
            margin-right: 16px;
            background-size: cover;
            background-position: center;
        }

        .ch-info {
            flex: 1;
        }

        .ch-title {
            font-size: 15px;
            font-weight: 600;
            color: #222;
            margin-bottom: 4px;
        }

        .ch-meta {
            font-size: 12px;
            color: #888;
        }

        .ch-btn {
            padding: 6px 14px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 12px;
            color: #555;
            background: white;
        }

        /* Mobile Adjustments */
        @media (max-width: 768px) {
            .detail-hero {
                height: auto;
                padding-top: 60px;
                min-height: auto;
                align-items: flex-start;
            }

            .detail-bg {
                filter: blur(60px) brightness(0.3);
                opacity: 0.8;
            }

            .detail-gradient {
                background: linear-gradient(to bottom, transparent, #121212);
            }

            .detail-content {
                flex-direction: row;
                padding: 20px;
                align-items: flex-start;
            }

            .detail-cover-img {
                width: 100px;
            }

            .detail-title {
                font-size: 24px;
                margin-top: 20px;
            }

            .detail-body {
                border-radius: 24px 24px 0 0;
                margin-top: -20px;
                position: relative;
                z-index: 20;
                padding-top: 30px;
            }
        }
    </style>
</head>

<body>
    <!-- HEADER -->
    <header>
        <div class="header-inner">
            <a href="index.html" class="brand">CRAFIQ</a>
            <nav class="nav-pc desktop-only">
                <a href="index.html">í™ˆ</a>
                <a href="discover.html">íƒìƒ‰</a>
                <a href="best.html">ë² ìŠ¤íŠ¸</a>
                <a href="my.html">MY</a>
            </nav>
            <div class="header-right-pc desktop-only">
                <a href="dashboard.html" class="btn-studio">ìŠ¤íŠœë””ì˜¤</a>
            </div>
        </div>
    </header>

    <div class="detail-hero">
        <div id="bg" class="detail-bg"></div>
        <div class="detail-gradient"></div>

        <div class="detail-content">
            <img id="cover" class="detail-cover-img" src="https://via.placeholder.com/200x300">
            <div class="detail-info">
                <div id="tags" style="display:flex; flex-wrap:wrap;">
                    <!-- Tags injected -->
                </div>
                <h1 id="title" class="detail-title">Loading...</h1>
                <div id="author" class="detail-author">Loading...</div>
                <div class="detail-metrics">
                    <span>ğŸ‘ 12.5M</span>
                    <span>â­ 9.8</span>
                    <span>â¤ï¸ 142k</span>
                </div>
            </div>
        </div>
    </div>

    <div class="detail-body">
        <div class="container">
            <!-- Action Buttons -->
            <div class="action-area">
                <button id="readStartBtn" class="btn-play-lg">
                    <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M8 5v14l11-7z" />
                    </svg>
                    <span id="readBtnText">ì²«í™” ë³´ê¸°</span>
                </button>
                <button class="btn-sub">â¤ï¸</button>
                <button class="btn-sub">ğŸ”—</button>
                <button id="editBtn" class="btn-sub" style="display:none; font-size:14px; width:auto; padding:0 20px;"
                    onclick="openEdit()">ìˆ˜ì •</button>
            </div>

            <div id="desc" class="synopsis">
                ì‘í’ˆ ì†Œê°œ ë¡œë”© ì¤‘...
            </div>

            <h3 style="font-size:20px; font-weight:800; margin-bottom:16px;">íšŒì°¨ ëª©ë¡</h3>
            <div id="listContainer" class="chapter-list">
                <div style="padding:40px; text-align:center; color:#999;">íšŒì°¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤.</div>
            </div>
        </div>
    </div>

    <!-- MOBILE NAV -->
    <nav class="bottom-nav mobile-only">
        <a href="index.html" class="nav-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z" />
            </svg><span>í™ˆ</span></a>
        <a href="discover.html" class="nav-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <circle cx="12" cy="12" r="10" />
                <path d="M16 8l-2 6-6 2 2-6 6-2z" />
            </svg><span>íƒìƒ‰</span></a>
        <a href="best.html" class="nav-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2l3 9h9l-7 5 3 9-8-5-8 5 3-9-7-5h9z" />
            </svg><span>ë² ìŠ¤íŠ¸</span></a>
        <a href="my.html" class="nav-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2" />
                <circle cx="12" cy="7" r="4" />
            </svg><span>MY</span></a>
    </nav>

    <!-- LOGIC -->
    <script type="module">
        import { getNovelById, getChapters, getScenes } from './js/data.js';
        import { getCurrentUser } from './js/auth.js';

        let currentNovel = null;

        async function initDetail() {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');
            if (!id) return alert("ì‘í’ˆ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");

            const [user, { data: novel }] = await Promise.all([
                getCurrentUser(),
                getNovelById(id)
            ]);

            if (!novel) {
                alert("ì‚­ì œë˜ê±°ë‚˜ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì‘í’ˆì…ë‹ˆë‹¤.");
                location.href = 'index.html';
                return;
            }

            currentNovel = novel;

            // Render basic info
            document.getElementById('bg').style.backgroundImage = `url('${novel.cover_url}')`;
            document.getElementById('cover').src = novel.cover_url;
            document.getElementById('title').innerText = novel.title;
            document.getElementById('author').innerText = novel.profiles?.username || 'ì‘ê°€ ë¯¸ìƒ';
            document.getElementById('desc').innerText = novel.description || novel.synopsis || "ì‘í’ˆ ì†Œê°œê°€ ì—†ìŠµë‹ˆë‹¤.";

            // Tags
            const tagContainer = document.getElementById('tags');
            // Mock tags or real genre
            const genre = novel.genre || 'Fantasy';
            tagContainer.innerHTML = `<span class="tag-badge">${genre}</span><span class="tag-badge">ë…ì </span>`;

            // Button Action
            const targetHtml = novel.is_visual_novel ? 'play.html' : 'read.html';
            document.getElementById('readStartBtn').onclick = () => location.href = `${targetHtml}?id=${novel.id}`;
            document.getElementById('readBtnText').innerText = novel.is_visual_novel ? "ê²Œì„ ì‹œì‘" : "ì²«í™” ë³´ê¸°";

            // Edit Rights
            if (user && user.id === novel.creator_id) {
                document.getElementById('editBtn').style.display = 'flex';
                document.getElementById('editBtn').onclick = () => location.href = `novel-settings.html?id=${novel.id}`;
            }

            // Load List
            const listFn = novel.is_visual_novel ? getScenes : getChapters;
            const { data: list } = await listFn(novel.id);
            const container = document.getElementById('listContainer');

            if (!list || list.length === 0) {
                container.innerHTML = '<div style="padding:40px; text-align:center; color:#999;">ë“±ë¡ëœ íšŒì°¨ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            container.innerHTML = list.map((item, i) => `
                <div class="chapter-item" onclick="location.href='${targetHtml}?id=${novel.id}&chapter=${i}'">
                    <div class="ch-thumb" style="background-image:url('${novel.cover_url}')"></div>
                    <div class="ch-info">
                        <div class="ch-title">${i + 1}í™”. ${item.title}</div>
                        <div class="ch-meta">${new Date(item.created_at).toLocaleDateString()} â€¢ Free</div>
                    </div>
                    <button class="ch-btn">ë³´ê¸°</button>
                </div>
            `).join('');
        }

        window.addEventListener('DOMContentLoaded', initDetail);
    </script>
</body>

</html>
<!-- Pretendard Font -->
<link rel="stylesheet" as="style" crossOrigin
    href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
<link rel="stylesheet" href="style.css">

<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script type="module" src="js/turbo-router.js"></script>

<style>
    .detail-hero {
        position: relative;
        width: 100%;
        height: 320px;
        overflow: hidden;
        display: flex;
        align-items: flex-end;
    }

    .detail-bg {
        position: absolute;
        inset: 0;
        background-size: cover;
        background-position: center;
        filter: blur(20px) brightness(0.5);
        transform: scale(1.1);
    }

    .detail-info-wrap {
        position: relative;
        width: 100%;
        max-width: 1080px;
        margin: 0 auto;
        padding: 30px 16px;
        display: flex;
        gap: 24px;
        align-items: flex-end;
        z-index: 10;
    }

    .detail-cover {
        width: 160px;
        height: 230px;
        border-radius: 6px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        background: #eee;
        object-fit: cover;
        flex-shrink: 0;
    }

    .detail-text {
        flex: 1;
        color: white;
        margin-bottom: 10px;
    }

    .detail-title {
        font-size: 28px;
        font-weight: 800;
        margin-bottom: 8px;
        line-height: 1.3;
    }

    .detail-meta {
        font-size: 14px;
        opacity: 0.8;
    }

    .action-bar {
        padding: 16px 0;
        border-bottom: 1px solid #eee;
        margin-bottom: 20px;
    }

    .btn-read {
        background: #1f8ce6;
        color: white;
        padding: 10px 24px;
        border-radius: 24px;
        font-weight: 700;
        border: none;
        font-size: 15px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .btn-edit {
        background: #333;
        color: white;
        padding: 10px 16px;
        border-radius: 24px;
        font-weight: 700;
        border: none;
        font-size: 14px;
        cursor: pointer;
        margin-left: 10px;
    }

    .chapter-list {
        display: flex;
        flex-direction: column;
    }

    .chapter-item {
        padding: 16px 0;
        border-bottom: 1px solid #f5f5f5;
        display: flex;
        align-items: center;
        cursor: pointer;
        transition: 0.2s;
    }

    .chapter-item:hover {
        background: #fafafa;
    }

    .ch-num {
        width: 40px;
        font-weight: 700;
        color: #1f8ce6;
        font-size: 16px;
    }

    .ch-title {
        flex: 1;
        font-size: 15px;
        font-weight: 600;
        color: #333;
    }

    .ch-date {
        font-size: 12px;
        color: #999;
    }

    /* Modal */
    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index: 2000;
        display: none;
        align-items: center;
        justify-content: center;
    }

    .modal {
        background: white;
        width: 400px;
        padding: 24px;
        border-radius: 12px;
    }

    .modal textarea {
        width: 100%;
        height: 100px;
        margin-top: 8px;
        border: 1px solid #ddd;
        padding: 8px;
    }
</style>

<script type="module">
    import { getNovelById, getChapters, getScenes, updateNovel } from './js/data.js';
    import { getCurrentUser } from './js/auth.js';

    let currentNovel = null;

    window.addEventListener('DOMContentLoaded', async () => {
        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');
        if (!id) return alert("ì‘í’ˆ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");

        // Load Novel and User
        const [user, { data: novel }] = await Promise.all([
            getCurrentUser(),
            getNovelById(id)
        ]);

        currentNovel = novel;
        renderNovelInfo(novel);

        // Check Ownership
        if (user && user.id === novel.creator_id) {
            document.getElementById('editBtn').style.display = 'inline-block';
        }

        // Load Content List
        if (novel.is_visual_novel) {
            loadScenes(id);
            document.getElementById('readBtnText').innerText = "ê²Œì„ í”Œë ˆì´";
        } else {
            loadChapters(id);
        }
    });

    function renderNovelInfo(novel) {
        document.getElementById('bg').style.backgroundImage = `url('${novel.cover_url}')`;
        document.getElementById('cover').src = novel.cover_url;
        document.getElementById('title').innerText = novel.title;
        document.getElementById('author').innerText = novel.profiles?.username || 'ì‘ê°€';
        document.getElementById('desc').innerText = novel.description || "ì‘í’ˆ ì†Œê°œê°€ ì—†ìŠµë‹ˆë‹¤.";

        // Set Read Button Action
        const btn = document.getElementById('readStartBtn');
        const targetHtml = novel.is_visual_novel ? 'play.html' : 'read.html';
        btn.onclick = () => location.href = `${targetHtml}?id=${novel.id}`;
    }

    async function loadChapters(id) {
        const { data: chapters } = await getChapters(id);
        renderList(chapters, 'read.html');
    }

    async function loadScenes(id) {
        const { data: scenes } = await getScenes(id);
        renderList(scenes, 'play.html');
    }

    function renderList(list, targetPage) {
        const container = document.getElementById('listContainer');
        if (!list || list.length === 0) {
            container.innerHTML = '<div style="padding:40px; text-align:center; color:#999;">ì•„ì§ ë“±ë¡ëœ í™”ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }
        container.innerHTML = list.map((item, idx) => `
                <div class="chapter-item" onclick="location.href='${targetPage}?id=${currentNovel.id}'">
                    <div class="ch-num">${idx + 1}</div>
                    <div class="ch-title">${item.title}</div>
                    <div class="ch-date">${new Date(item.created_at).toLocaleDateString()}</div>
                </div>
            `).join('');
    }

    // Edit Logic
    window.openEdit = () => {
        document.getElementById('editModal').style.display = 'flex';
        document.getElementById('editTitle').value = currentNovel.title;
        document.getElementById('editDesc').value = currentNovel.description || '';
        document.getElementById('editCover').value = currentNovel.cover_url || '';
    };
    window.closeEdit = () => document.getElementById('editModal').style.display = 'none';

    window.saveEdit = async () => {
        const btn = document.getElementById('saveBtn');
        btn.innerText = "ì €ì¥ ì¤‘...";

        const updates = {
            title: document.getElementById('editTitle').value,
            description: document.getElementById('editDesc').value,
            cover_url: document.getElementById('editCover').value
        };

        const { error } = await updateNovel(currentNovel.id, updates);
        if (error) alert(error.message);
        else location.reload();
    };
</script>
</head>

<body>
    <header>
        <div class="header-inner">
            <a href="index.html" class="brand">CRAFIQ</a>
            <div class="header-right-pc" style="margin-left:auto;">
                <a href="index.html" style="font-size:14px; font-weight:700;">í™ˆìœ¼ë¡œ</a>
            </div>
        </div>
    </header>

    <div id="bg" class="detail-bg"></div>

    <div class="detail-hero">
        <div class="detail-info-wrap">
            <img id="cover" class="detail-cover">
            <div class="detail-text">
                <div style="font-size:13px; font-weight:700; color:#66cdff; margin-bottom:4px;">ë…ì  ì—°ì¬</div>
                <h1 id="title" class="detail-title">Loading...</h1>
                <div id="author" class="detail-meta">Loading...</div>
                <div style="margin-top:10px; display:flex; gap:4px;">
                    <div class="tag-sm" style="background:rgba(255,255,255,0.2); color:white; border:none;">íŒíƒ€ì§€</div>
                    <div class="tag-sm" style="background:rgba(255,255,255,0.2); color:white; border:none;">ë¨¼ì¹˜í‚¨</div>
                </div>
            </div>
        </div>
    </div>

    <main class="inner" style="padding: 0 16px 80px;">
        <div class="action-bar">
            <button id="readStartBtn" class="btn-read">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M8 5v14l11-7z" />
                </svg>
                <span id="readBtnText">ì²«í™” ë³´ê¸°</span>
            </button>
            <button id="editBtn" class="btn-edit" style="display:none;" onclick="openEdit()">ì‘í’ˆ ì •ë³´ ìˆ˜ì •</button>
        </div>

        <div style="max-width:800px;">
            <p id="desc" style="color:#555; line-height:1.6; margin-bottom:40px;">
                ì‘í’ˆ ì†Œê°œê°€ ì—†ìŠµë‹ˆë‹¤.
            </p>

            <h3 class="sec-title">íšŒì°¨ ëª©ë¡</h3>
            <div id="listContainer" class="chapter-list">
                <!-- List -->
            </div>
        </div>
    </main>

    <!-- Edit Modal -->
    <div id="editModal" class="modal-overlay">
        <div class="modal">
            <h3 style="margin-bottom:16px;">ì‘í’ˆ ì •ë³´ ìˆ˜ì •</h3>
            <div style="margin-bottom:12px;">
                <label style="font-size:12px; font-weight:700; color:#888;">ì œëª©</label>
                <input id="editTitle" type="text" class="input-field" style="height:36px;">
            </div>
            <div style="margin-bottom:12px;">
                <label style="font-size:12px; font-weight:700; color:#888;">í‘œì§€ ì´ë¯¸ì§€ URL</label>
                <input id="editCover" type="text" class="input-field" style="height:36px;">
            </div>
            <div style="margin-bottom:16px;">
                <label style="font-size:12px; font-weight:700; color:#888;">ì¤„ê±°ë¦¬ ì†Œê°œ</label>
                <textarea id="editDesc"></textarea>
            </div>
            <div style="display:flex; justify-content:flex-end; gap:8px;">
                <button onclick="closeEdit()"
                    style="padding:8px 16px; border:1px solid #ddd; background:white; border-radius:4px; cursor:pointer;">ì·¨ì†Œ</button>
                <button id="saveBtn" onclick="saveEdit()"
                    style="padding:8px 16px; border:none; background:#1f8ce6; color:white; border-radius:4px; cursor:pointer;">ì €ì¥</button>
            </div>
        </div>
    </div>
</body>

</html>