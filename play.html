<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRAFIQ Player</title>
    <link rel="stylesheet" as="style" crossOrigin
        href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <link rel="stylesheet" href="style.css">
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module" src="js/turbo-router.js"></script>

    <style>
        body {
            background: #000;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            /* Changed for layout */
            margin: 0;
            /* align-items: center; Removed to allow full width content */
        }

        .game-stage {
            width: 100%;
            max-width: 1280px;
            aspect-ratio: 16/9;
            background: #222;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
        }

        .bg-layer {
            position: absolute;
            inset: 0;
            background-size: cover;
            background-position: center;
            transition: opacity 1s;
        }

        .actor-layer {
            position: absolute;
            inset: 0;
            pointer-events: none;
        }

        .actor {
            position: absolute;
            bottom: 0;
            height: 90%;
            transition: transform 0.5s, opacity 0.5s;
            filter: drop-shadow(0 0 10px rgba(0, 0, 0, 0.5));
        }

        .dialogue-box {
            position: absolute;
            bottom: 30px;
            left: 40px;
            right: 40px;
            height: 180px;
            background: rgba(0, 0, 0, 0.85);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 30px;
            display: flex;
            flex-direction: column;
            cursor: pointer;
            backdrop-filter: blur(4px);
        }

        .char-name {
            font-size: 24px;
            font-weight: 700;
            color: #ffdd59;
            margin-bottom: 12px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .dialogue-text {
            font-size: 20px;
            line-height: 1.6;
            color: #fff;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
        }

        .ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            pointer-events: none;
        }

        .ui-btn {
            pointer-events: auto;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }

        .start-screen {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .start-btn {
            font-size: 24px;
            padding: 16px 40px;
            background: #1f8ce6;
            color: white;
            border: none;
            border-radius: 50px;
            font-weight: 700;
            cursor: pointer;
            transition: 0.2s;
        }

        .start-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(31, 140, 230, 0.6);
        }
    </style>

    <script type="module">
        import { getNovelById, getScenes } from './js/data.js';

        /* RUNTIME ENGINE */
        const Runtime = {
            scenes: [],
            currentSceneIndex: 0,
            currentEventIndex: 0,
            autoPlay: false,

            async init() {
                const params = new URLSearchParams(window.location.search);
                const id = params.get('id');
                if (!id) return alert("No Game ID");

                // Load Data
                const { data: novel } = await getNovelById(id);
                if (novel) document.getElementById('gameTitle').innerText = novel.title;

                const { data: list } = await getScenes(id);
                // Simplify structure
                this.scenes = list.map(s => s.data);

                if (this.scenes.length > 0) {
                    document.querySelector('.start-screen').style.display = 'flex';
                }
            },

            start() {
                document.querySelector('.start-screen').style.display = 'none';
                this.executeScene(0);
            },

            executeScene(index) {
                if (index >= this.scenes.length) {
                    alert("End of Game");
                    return;
                }
                this.currentSceneIndex = index;
                this.currentEventIndex = 0;
                this.processEvent();
            },

            processEvent() {
                const scene = this.scenes[this.currentSceneIndex];
                if (!scene || !scene.events || this.currentEventIndex >= scene.events.length) {
                    // End of Scene -> Go Next
                    this.executeScene(this.currentSceneIndex + 1);
                    return;
                }

                const ev = scene.events[this.currentEventIndex];

                // --- EXECUTE EVENT ---

                if (ev.type === 'background') {
                    document.getElementById('bgLayer').style.backgroundImage = `url('${ev.url}')`;
                    // Auto proceed
                    this.next();
                }

                else if (ev.type === 'character') {
                    this.renderCharacter(ev);
                    this.next();
                }

                else if (ev.type === 'dialog') {
                    // STOP and Wait for Click
                    const box = document.querySelector('.dialogue-box');
                    box.style.opacity = 1;
                    document.getElementById('charName').innerText = ev.speaker;
                    document.getElementById('dialogueText').innerText = ev.text;
                    // Do NOT call next() automatically
                }

                else if (ev.type === 'sound') {
                    // TODO: Play Sound
                    this.next();
                }

                else {
                    console.warn("Unknown Event", ev);
                    this.next();
                }
            },

            renderCharacter(ev) {
                // Ensure char element exists
                let el = document.getElementById(`actor-${ev.name}`);
                if (!el) {
                    el = document.createElement('img');
                    el.id = `actor-${ev.name}`;
                    el.className = 'actor';
                    document.getElementById('actorLayer').appendChild(el);
                }
                if (ev.url) el.src = ev.url;

                // Position
                el.style.left = (ev.x * 100) + '%';
                el.style.transform = `translateX(-50%) scale(${ev.scale || 1})`;
            },

            next() {
                this.currentEventIndex++;
                // Small delay for processing/visuals
                setTimeout(() => this.processEvent(), 10);
            },

            // User Interaction
            onClick() {
                // Only proceed if we are waiting (i.e., currently showing dialog)
                const scene = this.scenes[this.currentSceneIndex];
                if (!scene) return;
                const ev = scene.events[this.currentEventIndex];

                if (ev && ev.type === 'dialog') {
                    this.next();
                }
            }
        };

        window.Runtime = Runtime;
        window.startGame = () => Runtime.start();
        window.nextStep = () => Runtime.onClick();

        window.addEventListener('DOMContentLoaded', () => Runtime.init());

    </script>
</head>

<body>
    <div style="width:100%; max-width:1280px; margin:0 auto; padding:20px;">

        <!-- Game Stage -->
        <div class="game-stage" onclick="nextStep()">
            <div id="bgLayer" class="bg-layer" style="background:#000;"></div>
            <div id="actorLayer" class="actor-layer"></div>

            <div class="ui-overlay">
                <button class="ui-btn" onclick="event.stopPropagation(); location.href='index.html'">나가기</button>
            </div>

            <div class="dialogue-box" style="opacity:0; transition:opacity 0.2s;">
                <div id="charName" class="char-name"></div>
                <div id="dialogueText" class="dialogue-text"></div>
            </div>

            <div class="start-screen">
                <h1 id="gameTitle" style="color:white; font-size:40px; margin-bottom:20px; text-shadow:0 0 10px black;">
                    Loading...</h1>
                <button class="start-btn" onclick="event.stopPropagation(); startGame()">Game Start</button>
            </div>
        </div>


        <!-- Comments Section -->
        <div style="margin-top:30px; color:white;">
            <h3 style="margin-bottom:15px;">댓글 <span id="commentCount">0</span></h3>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <input id="commentInput" type="text" placeholder="재미있게 보셨나요? 댓글을 남겨주세요!"
                    style="flex:1; background:#222; border:1px solid #444; color:white; padding:12px; border-radius:4px;">
                <button onclick="postComment()"
                    style="background:#1f8ce6; border:none; color:white; padding:0 20px; border-radius:4px; cursor:pointer;">등록</button>
            </div>
            <div id="commentList" style="display:flex; flex-direction:column; gap:20px;">
                <div style="color:#666;">로딩 중...</div>
            </div>
        </div>

    </div>
</body>

</html>