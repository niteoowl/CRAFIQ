<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì°½ì‘ì ìŠ¤íŠœë””ì˜¤ - CRAFIQ</title>
    <link rel="stylesheet" as="style" crossOrigin
        href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <link rel="stylesheet" href="style.css">

    <!-- Supabase -->
    <script type="module" src="js/init-supabase.js"></script>
    <script type="module" src="js/turbo-router.js"></script>

    <script type="module">
        import { getUserNovels, createNovel } from './js/data.js';

        // Ensure global access
        window.handleCreate = async (type) => {
            let title = prompt(type === 'novel' ? "ì›¹ì†Œì„¤ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”:" : "ë¹„ì£¼ì–¼ ë…¸ë²¨ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”:");

            while (title) {
                const { data, error } = await createNovel(title, type);
                if (error) {
                    // Check for Unique Violation (Postgres 23505) or 409 Conflict
                    if (error.code === '23505' || error.status === 409 || (error.message && error.message.includes('unique'))) {
                        title = prompt("âš ï¸ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì œëª©ì…ë‹ˆë‹¤.\në‹¤ë¥¸ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”:", title);
                    } else if (error.code === '23503') {
                        alert("í”„ë¡œí•„ ìƒì„± ì˜¤ë¥˜: ê³„ì •ì´ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë¡œê·¸ì•„ì›ƒ í›„ ë‹¤ì‹œ ë¡œê·¸ì¸í•´ë³´ì„¸ìš”.");
                        break;
                    } else {
                        alert("ì‹œìŠ¤í…œ ì˜¤ë¥˜: " + error.message);
                        console.error(error);
                        break;
                    }
                } else {
                    location.reload();
                    break;
                }
            }
        };

        async function initDashboard() {
            // Wait for auth to init
            await new Promise(r => setTimeout(r, 100));

            const listEl = document.getElementById('novelList');
            if (!listEl) return;

            listEl.innerHTML = '<div style="padding:20px; text-align:center;">ë¡œë”© ì¤‘...</div>';

            const { data: novels, error } = await getUserNovels();

            if (!novels || novels.length === 0) {
                listEl.innerHTML = '<div style="padding:40px; text-align:center; color:#888;">ì•„ì§ ìƒì„±í•œ ì‘í’ˆì´ ì—†ìŠµë‹ˆë‹¤.<br>ìœ„ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì°½ì‘ì„ ì‹œì‘í•´ë³´ì„¸ìš”!</div>';
                return;
            }

            listEl.innerHTML = novels.map(n => `
                <div class="studio-card" onclick="location.href='${n.is_visual_novel ? `studio-visual.html?id=${n.id}` : `studio-novel.html?id=${n.id}`}'">
                    <strong style="font-size:16px;">${n.title}</strong>
                    <div style="font-size:12px; color:#666; margin-top:4px;">
                        ${n.is_visual_novel ? 'ğŸ® ë¹„ì£¼ì–¼ ë…¸ë²¨' : 'ğŸ“– ì›¹ì†Œì„¤'} 
                        | ${new Date(n.created_at).toLocaleDateString()}
                    </div>
                </div>
            `).join('');
        }

        if (document.body) initDashboard();
        window.addEventListener('turbo:load', initDashboard);
    </script>
</head>

<body>
    <header>
        <div class="header-inner">
            <a href="index.html" class="brand">CRAFIQ Studio</a>
            <div class="header-right-pc" style="margin-left:auto;">
                <a href="index.html" style="font-size:14px; font-weight:700;">ë‚˜ê°€ê¸°</a>
            </div>
        </div>
    </header>

    <main class="inner" style="padding-top:40px;">
        <h2 class="sec-title" style="margin:0 16px 20px;">ë¬´ì—‡ì„ ì°½ì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h2>

        <div class="studio-option-grid">
            <div class="studio-card" onclick="window.handleCreate('novel')">
                <div style="font-size:24px; margin-bottom:8px;">ğŸ“–</div>
                <div style="font-weight:800; font-size:18px;">ì›¹ì†Œì„¤ ë§Œë“¤ê¸°</div>
                <div style="font-size:13px; color:#666; margin-top:4px;">í…ìŠ¤íŠ¸ ì¤‘ì‹¬ì˜ ìŠ¤í† ë¦¬í…”ë§</div>
            </div>
            <div class="studio-card" onclick="window.handleCreate('visual')">
                <div style="font-size:24px; margin-bottom:8px;">ğŸ®</div>
                <div style="font-weight:800; font-size:18px;">ë¹„ì£¼ì–¼ ë…¸ë²¨ ë§Œë“¤ê¸°</div>
                <div style="font-size:13px; color:#666; margin-top:4px;">ê²Œì„ì„ ë§Œë“œëŠ” ê°€ì¥ ì‰¬ìš´ ë°©ë²•</div>
            </div>
        </div>

        <h3 class="sec-title" style="margin:0 16px 16px;">ë‚´ ì‘í’ˆ ëª©ë¡</h3>
        <div id="novelList" class="studio-option-grid">
            <!-- Dynamic Load -->
        </div>

    </main>
</body>

</html>