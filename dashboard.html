<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRAFIQ ìŠ¤íŠœë””ì˜¤</title>
    <link rel="stylesheet" as="style" crossOrigin
        href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <link rel="stylesheet" href="style.css">

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module" src="js/turbo-router.js"></script>

    <script type="module">
        import { createNovel, getUserNovels } from './js/data.js';
        import { getCurrentUser } from './js/auth.js';

        async function initDashboard() {
            const user = await getCurrentUser();
            if (!user) {
                alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                window.location.href = "my.html";
                return;
            }

            // Load List
            loadMyNovels();
        }

        async function loadMyNovels() {
            const listContainer = document.getElementById('myNovelList');
            const { data, error } = await getUserNovels();

            if (error) {
                console.error(error);
                listContainer.innerHTML = `<div style="padding:20px;">ì˜¤ë¥˜ ë°œìƒ: ${error.message}</div>`;
                return;
            }

            if (data.length === 0) {
                listContainer.innerHTML = `<div style="padding:40px; text-align:center; color:#999;">ì•„ì§ ì‘í’ˆì´ ì—†ìŠµë‹ˆë‹¤.<br>ìƒˆ ì‘í’ˆì„ ë§Œë“¤ì–´ë³´ì„¸ìš”!</div>`;
                return;
            }

            listContainer.innerHTML = data.map(novel => `
                <div class="rank-item" onclick="openStudio('${novel.id}', '${novel.is_visual_novel ? 'visual' : 'novel'}')">
                    <div class="rank-thumb" style="width:50px; height:70px; background:#eee; display:flex; align-items:center; justify-content:center; font-size:20px;">
                        ${novel.is_visual_novel ? 'ğŸ®' : 'ğŸ“'}
                    </div>
                    <div class="rank-info">
                        <div class="rank-title">${novel.title}</div>
                        <div class="rank-desc">${novel.is_visual_novel ? 'ë¹„ì£¼ì–¼ ë…¸ë²¨' : 'ì›¹ì†Œì„¤'} â€¢ ${new Date(novel.created_at).toLocaleDateString()}</div>
                    </div>
                     <button class="tool-btn" style="border:1px solid #ddd; padding:4px 8px; color:#555;">í¸ì§‘</button>
                </div>
            `).join('');
        }

        window.openStudio = (id, type) => {
            if (type === 'novel') window.location.href = `studio-novel.html?id=${id}`;
            else window.location.href = `studio-visual.html?id=${id}`;
        };

        window.handleCreate = async (type) => {
            const title = prompt(type === 'novel' ? "ì›¹ì†Œì„¤ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" : "ë¹„ì£¼ì–¼ ë…¸ë²¨ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”");
            if (!title) return;

            const { data, error } = await createNovel(title, type);
            if (error) alert(error.message);
            else {
                alert("ì‘í’ˆì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!");
                loadMyNovels(); // Refresh
            }
        };

        window.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</head>

<body>
    <header>
        <div class="header-inner">
            <div style="display:flex; align-items:center;">
                <a href="index.html" class="brand">CRAFIQ Studio</a>
            </div>
            <div style="display:flex; align-items:center; gap:16px;">
                <div class="avatar"></div>
                <a href="index.html" style="font-size:14px; color:#555;">ë‚˜ê°€ê¸°</a>
            </div>
        </div>
    </header>

    <main class="inner" style="padding-top:40px;">
        <h2 class="sec-title" style="margin: 0 16px 24px;">ì‘í’ˆ ì œì‘</h2>

        <div class="studio-option-grid">
            <!-- Create Novel -->
            <div class="studio-card" onclick="handleCreate('novel')">
                <div class="studio-icon">
                    <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7" />
                        <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z" />
                    </svg>
                </div>
                <h3>ì›¹ì†Œì„¤ ì œì‘</h3>
                <p>ì „ë¬¸ ì§‘í•„ ë„êµ¬<br>ì„¤ì •ì§‘ + Zen ëª¨ë“œ</p>
                <div style="margin-top:12px; color:#007acc; font-weight:700; font-size:13px;">+ ìƒˆ ì›¹ì†Œì„¤ ë§Œë“¤ê¸°</div>
            </div>

            <!-- Create Visual Novel -->
            <div class="studio-card" onclick="handleCreate('visual')">
                <div class="studio-icon" style="color:#6c5ce7;">
                    <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path
                            d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z" />
                    </svg>
                </div>
                <h3>ë¹„ì£¼ì–¼ ë…¸ë²¨ ì œì‘</h3>
                <p>ê²Œì„ ì—”ì§„í˜• ì—ë””í„°<br>íƒ€ì„ë¼ì¸ + ì—°ì¶œ íš¨ê³¼</p>
                <div style="margin-top:12px; color:#6c5ce7; font-weight:700; font-size:13px;">+ ìƒˆ í”„ë¡œì íŠ¸ ë§Œë“¤ê¸°</div>
            </div>
        </div>

        <section style="margin-top:40px;">
            <h3 class="sec-title" style="margin: 0 16px 20px;">ë‚´ ì‘í’ˆ ëª©ë¡</h3>
            <div id="myNovelList" style="border-top:1px solid #eee; margin: 0 16px;">
                <!-- Content will be loaded here -->
                <div style="padding:20px; text-align:center;">ë¡œë”© ì¤‘...</div>
            </div>
        </section>
    </main>
</body>

</html>