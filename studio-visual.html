<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRAFIQ Visual Studio</title>
    <link rel="stylesheet" as="style" crossOrigin
        href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <link rel="stylesheet" href="style.css">
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module" src="js/init-supabase.js"></script>
    <script type="module" src="js/turbo-router.js"></script>

    <script type="module">
        import { getNovelById, getScenes, createScene, saveSceneData } from './js/data.js';

        let currentNovelId = null;
        let currentSceneId = null;
        // Mock State for Editor
        let sceneData = {
            bg: 'https://images.unsplash.com/photo-1596727147705-54a7128052a9?w=1000',
            actors: [
                { name: 'ì§€ìˆ˜', image: 'https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=400', x: 100, dialog: "ì˜¤ëŠ˜ë„ ëŠ¦ì—ˆë„¤? ë¹¨ë¦¬ì™€!" }
            ],
            bgm: 'Bensound - Epic'
        };

        window.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            currentNovelId = params.get('id');

            if (!currentNovelId) {
                // For demo/fallback
                if (!confirm("í”„ë¡œì íŠ¸ IDê°€ ì—†ìŠµë‹ˆë‹¤. ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°ˆê¹Œìš”? (ì·¨ì†Œ ì‹œ ë°ëª¨ ëª¨ë“œ)")) {
                    // Demo Mode
                } else {
                    window.location.href = 'dashboard.html';
                }
            } else {
                const { data: novel } = await getNovelById(currentNovelId);
                if (novel) document.getElementById('projectTitle').innerText = novel.title + " - Scene Editor";
                loadSceneList();
            }
        });

        async function loadSceneList() {
            if (!currentNovelId) return;
            const listEl = document.getElementById('sceneList');
            const { data: scenes } = await getScenes(currentNovelId);

            listEl.innerHTML = '';
            if (scenes && scenes.length > 0) {
                scenes.forEach(s => {
                    const div = document.createElement('div');
                    div.className = `chapter-list-item ${currentSceneId === s.id ? 'active' : ''}`;
                    div.innerText = s.title;
                    div.onclick = () => loadScene(s);
                    listEl.appendChild(div);
                });
                if (!currentSceneId) loadScene(scenes[0]);
            } else {
                listEl.innerHTML = '<div style="padding:10px; color:#666;">ì”¬ì´ ì—†ìŠµë‹ˆë‹¤. (+ ë²„íŠ¼)</div>';
            }
        }

        async function loadScene(scene) {
            currentSceneId = scene.id;
            sceneData = scene.data || sceneData; // Load data or keep default mock if empty
            renderStage();

            document.querySelectorAll('.chapter-list-item').forEach(el => el.classList.remove('active'));
            // Refetch or redraw list active state... simplified here:
            loadSceneList(); // Quick refresh
        }

        window.addScene = async () => {
            if (!currentNovelId) return alert("ì €ì¥í•˜ë ¤ë©´ ë¨¼ì € ëŒ€ì‹œë³´ë“œì—ì„œ í”„ë¡œì íŠ¸ë¥¼ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.");
            const title = prompt("ìƒˆ ì¥ë©´ ì œëª© (ì˜ˆ: S1. í•™êµ ì •ë¬¸)");
            if (!title) return;

            const { data: list } = await getScenes(currentNovelId);
            const idx = list ? list.length + 1 : 1;

            await createScene(currentNovelId, title, idx);
            loadSceneList();
        };

        window.saveProject = async () => {
            if (!currentSceneId) return alert("ì„ íƒëœ ì”¬ì´ ì—†ìŠµë‹ˆë‹¤.");
            const btn = document.getElementById('saveBtn');
            btn.innerText = "ì €ì¥ì¤‘...";

            // In real app, we would gather data from DOM. 
            // Here we just save the 'sceneData' object which we mock-modify.
            const { error } = await saveSceneData(currentSceneId, sceneData);

            if (error) alert(error.message);
            else {
                btn.innerText = "ì €ì¥ ì™„ë£Œ";
                setTimeout(() => btn.innerText = "í”„ë¡œì íŠ¸ ì €ì¥", 2000);
            }
        };

        function renderStage() {
            // Update DOM based on sceneData
            document.getElementById('stageInfo').innerText = `Current BG: ${sceneData.bg.substring(0, 20)}...`;
        }

        /* Mock Asset Selection */
        window.selectAsset = (name) => {
            alert(name + " ì„ íƒë¨ -> íƒ€ì„ë¼ì¸ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤ (ê°€ìƒ)");
            sceneData.bgm = name;
        }

    </script>
</head>

<body class="studio-body">
    <!-- Top Bar -->
    <div class="studio-header">
        <div class="studio-title">
            <a href="dashboard.html" style="color:#888; margin-right:8px;"><svg width="16" height="16" fill="none"
                    stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M19 12H5M12 19l-7-7 7-7" />
                </svg></a>
            <span id="projectTitle">New Project - Scene Editor</span>
        </div>
        <div class="studio-toolbar">
            <button class="tool-btn"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"
                    viewBox="0 0 24 24">
                    <polygon points="5 3 19 12 5 21 5 3" />
                </svg> í”Œë ˆì´ í…ŒìŠ¤íŠ¸</button>
            <div style="width:1px; height:16px; background:#444; margin:0 8px;"></div>
            <button class="tool-btn primary" id="saveBtn" onclick="saveProject()"> í”„ë¡œì íŠ¸ ì €ì¥</button>
            <button class="tool-btn" style="background:#e91e63; color:white;">ë°°í¬ (Build)</button>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="studio-layout">
        <!-- Left Panel: Scene Tree & Outline -->
        <div class="panel-left">
            <div class="panel-header">
                <span>SCENE LIST</span>
                <span style="margin-left:auto; cursor:pointer;" onclick="addScene()">+</span>
            </div>
            <div id="sceneList" class="panel-content">
                <!-- Loaded from DB -->
            </div>
            <div class="panel-header" style="margin-top:1px;">SCRIPT OUTLINE</div>
            <div class="panel-content" style="font-size:12px; color:#aaa; padding:10px;">
                * ì„ íƒëœ ì”¬ì˜ ìŠ¤í¬ë¦½íŠ¸ ìš”ì•½ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
            </div>
        </div>

        <!-- Center: Visual Stage & Timeline -->
        <div class="panel-center">
            <!-- Stage -->
            <div class="stage-area">
                <div class="stage-canvas"
                    style="background-image:url('https://images.unsplash.com/photo-1596727147705-54a7128052a9?w=1000'); background-size:cover;">
                    <div id="stageInfo"
                        style="position:absolute; top:10px; left:10px; background:rgba(0,0,0,0.5); color:white; font-size:10px; padding:4px;">
                        BG Loading...</div>

                    <!-- Mock Character -->
                    <img src="https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=400"
                        style="position:absolute; bottom:0; left:100px; height:400px; filter:drop-shadow(0 0 10px rgba(0,0,0,0.5));">
                    <!-- Dialogue Box UI -->
                    <div
                        style="position:absolute; bottom:20px; left:20px; right:20px; height:120px; background:rgba(0,0,0,0.8); border:2px solid #fff; border-radius:8px; padding:16px; display:flex;">
                        <div style="width:100px; font-weight:700; color:#ffdd59; font-size:18px;">ì§€ìˆ˜</div>
                        <div style="flex:1; color:white; font-size:16px;">"ì˜¤ëŠ˜ë„ ëŠ¦ì—ˆë„¤? ë¹¨ë¦¬ì™€!"</div>
                    </div>
                </div>
            </div>

            <!-- Timeline -->
            <div class="timeline-area">
                <div class="panel-header">TIMELINE</div>
                <div class="panel-content" style="background:#222;">
                    <!-- Track 1: BG -->
                    <div class="timeline-track">
                        <div class="track-header">ë°°ê²½ (BG)</div>
                        <div class="track-content">
                            <div
                                style="position:absolute; left:0; width:300px; height:100%; background:#4caf50; opacity:0.3; border:1px solid #4caf50;">
                                School_Gate.jpg</div>
                        </div>
                    </div>
                    <!-- Track 2: Char -->
                    <div class="timeline-track">
                        <div class="track-header">ìºë¦­í„°</div>
                        <div class="track-content">
                            <div
                                style="position:absolute; left:50px; width:200px; height:100%; background:#2196f3; opacity:0.3; border:1px solid #2196f3;">
                                ì§€ìˆ˜ (Smile)</div>
                        </div>
                    </div>
                    <!-- Track 3: Sound -->
                    <div class="timeline-track">
                        <div class="track-header">ì‚¬ìš´ë“œ (BGM)</div>
                        <div class="track-content">
                            <div
                                style="position:absolute; left:0; width:400px; height:100%; background:#ff9800; opacity:0.3; border:1px solid #ff9800;">
                                Bright_Morning.mp3</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right: Assets & Properties -->
        <div class="panel-right">
            <div class="panel-header" style="background:#007acc; color:white;">ASSET LIBRARY (Free)</div>
            <div style="height:50%; border-bottom:1px solid #000; display:flex; flex-direction:column;">
                <!-- TABS -->
                <div style="display:flex; background:#2d2d30;">
                    <div
                        style="flex:1; text-align:center; padding:8px; font-size:11px; background:#3e3e42; color:white;">
                        BGM (Free)</div>
                    <div style="flex:1; text-align:center; padding:8px; font-size:11px; color:#888;">Images</div>
                </div>
                <!-- BGM LIST (Massive Mockup) -->
                <div class="panel-content">
                    <div class="asset-grid">
                        <!-- Creative Commons Mocks -->
                        <div class="asset-item" onclick="selectAsset('Kevin MacLeod - Monkeys Spinning Monkeys')">
                            <div class="asset-thumb" style="background:#ff9800;">ğŸµ</div>
                            <div class="asset-name">Monkeys...</div>
                        </div>
                        <div class="asset-item" onclick="selectAsset('Bensound - Epic')">
                            <div class="asset-thumb" style="background:#ff9800;">ğŸµ</div>
                            <div class="asset-name">Epic Theme</div>
                        </div>
                        <!-- More items... -->
                    </div>
                </div>
            </div>

            <!-- INSPECTOR -->
            <div class="panel-header">PROPERTIES</div>
            <div class="panel-content" style="padding:10px;">
                <div class="prop-row">
                    <div class="prop-label">ì´ë¦„</div>
                    <input class="prop-input" value="ì§€ìˆ˜ (Smile)">
                </div>
            </div>
        </div>
    </div>
</body>

</html>