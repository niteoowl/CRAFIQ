<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>CRAFIQ Visual Studio Pro</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module" src="js/init-supabase.js"></script>

    <style>
        body {
            background: #181818;
            color: #eee;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .studio-header {
            height: 50px;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
            background: #222;
        }

        .studio-title {
            font-weight: 700;
            font-size: 16px;
            color: #fff;
        }

        .action-btn {
            background: #1f8ce6;
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: 0.2s;
        }

        .action-btn:hover {
            background: #0c75ce;
        }

        .action-btn.secondary {
            background: #444;
        }

        /* Main Layout */
        .workspace {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* Left: Scene List */
        .panel-left {
            width: 250px;
            background: #222;
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
        }

        .scene-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .scene-item {
            padding: 10px;
            margin-bottom: 8px;
            background: #333;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .scene-item:hover {
            background: #3a3a3a;
        }

        .scene-item.active {
            border-color: #1f8ce6;
            background: #2a2a2a;
        }

        .scene-thumb {
            width: 40px;
            height: 40px;
            background: #000;
            border-radius: 4px;
            object-fit: cover;
        }

        .scene-meta {
            flex: 1;
            overflow: hidden;
        }

        .scene-idx {
            font-size: 10px;
            color: #888;
            font-weight: bold;
        }

        .scene-summary {
            font-size: 13px;
            color: #ccc;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Center: Stage Preview */
        .panel-center {
            flex: 1;
            background: #111;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 40px;
        }

        .stage-wrapper {
            width: 960px;
            height: 540px;
            background: #000;
            position: relative;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            border: 1px solid #333;
        }

        .preview-bg {
            position: absolute;
            inset: 0;
            background-size: cover;
            background-position: center;
        }

        .preview-char {
            position: absolute;
            bottom: 0;
            height: 90%;
            left: 50%;
            transform: translateX(-50%);
            filter: drop-shadow(0 0 10px rgba(0, 0, 0, 0.5));
            transition: 0.3s;
        }

        .preview-dialog {
            position: absolute;
            bottom: 30px;
            left: 40px;
            right: 40px;
            height: 160px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 25px;
            display: flex;
            flex-direction: column;
        }

        .preview-name {
            font-size: 22px;
            font-weight: bold;
            color: #ffdd59;
            margin-bottom: 10px;
        }

        .preview-text {
            font-size: 18px;
            line-height: 1.5;
            color: white;
            white-space: pre-wrap;
        }

        .preview-choices {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            pointer-events: none;
        }

        .choice-btn-preview {
            padding: 10px 30px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #1f8ce6;
            color: #1f8ce6;
            border-radius: 30px;
            font-weight: bold;
            min-width: 300px;
            text-align: center;
        }

        /* Right: Inspector */
        .panel-right {
            width: 320px;
            background: #222;
            border-left: 1px solid #333;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .prop-group {
            border-bottom: 1px solid #333;
            padding: 15px;
        }

        .prop-title {
            font-size: 12px;
            font-weight: 700;
            color: #888;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .input-row {
            margin-bottom: 12px;
        }

        .input-label {
            font-size: 12px;
            color: #ccc;
            margin-bottom: 4px;
            display: block;
        }

        .form-input {
            width: 100%;
            background: #111;
            border: 1px solid #444;
            color: white;
            padding: 8px;
            border-radius: 4px;
            font-size: 13px;
        }

        .form-input:focus {
            border-color: #1f8ce6;
            outline: none;
        }

        .form-textarea {
            height: 80px;
            resize: vertical;
        }

        /* Helper Classes */
        .flex-row {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            padding: 4px;
            border: 1px solid #444;
            background: #333;
            color: #ccc;
            border-radius: 4px;
            cursor: pointer;
            flex: 1;
            text-align: center;
            font-size: 12px;
        }

        .btn-icon:hover {
            background: #444;
        }

        .btn-icon.active {
            background: #1f8ce6;
            border-color: #1f8ce6;
            color: white;
        }
    </style>
</head>

<body>

    <div class="studio-header">
        <div style="display:flex; align-items:center; gap:12px;">
            <button onclick="location.href='dashboard.html'" class="action-btn secondary">‚óÄ ÎÇòÍ∞ÄÍ∏∞</button>
            <span id="novelTitle" class="studio-title">Ï†úÎ™© Î°úÎî©Ï§ë...</span>
        </div>
        <div style="display:flex; gap:10px;">
            <button onclick="addScene()" class="action-btn secondary">+ Ïû•Î©¥ Ï∂îÍ∞Ä</button>
            <button onclick="saveAll()" class="action-btn">üíæ Ï†ÄÏû•ÌïòÍ∏∞</button>
        </div>
    </div>

    <div class="workspace">

        <!-- SCENE LIST -->
        <div class="panel-left">
            <div class="prop-group" style="padding:10px; background:#2a2a2a;">
                <input placeholder="Ïû•Î©¥ Í≤ÄÏÉâ..." class="form-input" style="font-size:12px;">
            </div>
            <div id="sceneList" class="scene-list">
                <!-- Items injected here -->
            </div>
        </div>

        <!-- STAGE PREVIEW -->
        <div class="panel-center">
            <div id="stage" class="stage-wrapper">
                <div id="pBg" class="preview-bg"></div>
                <img id="pChar" class="preview-char" src="" style="display:none;">
                <div id="pChoices" class="preview-choices" style="display:none;"></div>
                <div id="pDialogBox" class="preview-dialog">
                    <div id="pName" class="preview-name">Ïù¥Î¶Ñ</div>
                    <div id="pText" class="preview-text">ÎåÄÏÇ¨ ÎÇ¥Ïö©...</div>
                </div>
            </div>
            <div style="margin-top:10px; color:#666; font-size:12px;">Pretendard 16:9 HD Preview</div>
        </div>

        <!-- INSPECTOR -->
        <div class="panel-right" id="inspector">
            <div class="prop-group">
                <div class="prop-title">Î∞∞Í≤Ω & Ïù∏Î¨º (Background & Char)</div>
                <div class="input-row">
                    <label class="input-label">Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄ URL</label>
                    <input id="inBg" class="form-input" oninput="updateCurrentScene('bg', this.value)">
                </div>
                <div class="input-row">
                    <label class="input-label">Ï∫êÎ¶≠ÌÑ∞ Ïù¥ÎØ∏ÏßÄ URL</label>
                    <input id="inChar" class="form-input" oninput="updateCurrentScene('character', this.value)">
                </div>
                <!-- TODO: Character Position, Scale -->
            </div>

            <div class="prop-group">
                <div class="prop-title">ÎåÄÏÇ¨ (Dialogue)</div>
                <div class="input-row">
                    <label class="input-label">ÌôîÏûê Ïù¥Î¶Ñ (Speaker)</label>
                    <input id="inSpeaker" class="form-input" oninput="updateCurrentScene('speaker', this.value)">
                </div>
                <div class="input-row">
                    <label class="input-label">ÎåÄÏÇ¨ ÎÇ¥Ïö© (Text)</label>
                    <textarea id="inText" class="form-input form-textarea"
                        oninput="updateCurrentScene('text', this.value)"></textarea>
                </div>
            </div>

            <div class="prop-group">
                <div class="prop-title">Ïª§Ïä§ÌÖÄ Ïä§ÌÉÄÏùº (Custom Style)</div>
                <div class="flex-row">
                    <div style="flex:1">
                        <label class="input-label">ÏÉÅÏûê Ìà¨Î™ÖÎèÑ</label>
                        <input id="inOpacity" type="range" class="form-input" min="0" max="1" step="0.1"
                            oninput="updateCurrentScene('boxOpacity', this.value)">
                    </div>
                </div>
                <div class="input-row" style="margin-top:10px;">
                    <label class="input-label">ÎåÄÌôî ÏÉÅÏûê CSS (Expert)</label>
                    <input id="inBoxStyle" class="form-input" placeholder="e.g. background: blue;"
                        oninput="updateCurrentScene('boxStyle', this.value)">
                </div>
            </div>

            <div class="prop-group">
                <div class="prop-title" style="display:flex; justify-content:space-between; align-items:center;">
                    <span>ÏÑ†ÌÉùÏßÄ (Choices)</span>
                    <button onclick="addChoice()" style="font-size:10px; padding:2px 8px; cursor:pointer;">+ Ï∂îÍ∞Ä</button>
                </div>
                <div id="choiceListEditor">
                    <!-- Choice Inputs -->
                </div>
            </div>

            <div class="prop-group">
                <button onclick="deleteCurrentScene()"
                    style="width:100%; padding:10px; background:#e74c3c; border:none; color:white; border-radius:4px; cursor:pointer;">Ïù¥
                    Ïû•Î©¥ ÏÇ≠Ï†úÌïòÍ∏∞</button>
            </div>
        </div>

    </div>

    <script type="module">
        import { getNovelById, getScenes, saveScenes } from './js/data.js';

        let novelId = null;
        let scenes = [];
        let activeIndex = -1;

        window.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            novelId = params.get('id');
            if (!novelId) return alert("Ïò§Î•ò: ÏûëÌíà IDÍ∞Ä ÏóÜÏäµÎãàÎã§.");

            // Get Basic Info
            const { data: novel } = await getNovelById(novelId);
            if (novel) document.getElementById('novelTitle').innerText = novel.title;

            // Get Scenes
            const { data: list } = await getScenes(novelId);
            if (list) {
                // Map DB List to Local model
                scenes = list.map(item => ({
                    id: item.id, // Scene DB ID
                    ...item.data // JSON Content
                }));
            }

            if (scenes.length === 0) addScene(); // Start with 1
            else selectScene(0);

            renderList();
        });

        // --- Core Actions ---

        window.addScene = () => {
            scenes.push({
                bg: 'https://images.unsplash.com/photo-1542256840-3b6201e52003?w=1000',
                character: '',
                speaker: 'ÏãúÏä§ÌÖú',
                text: 'ÏÉàÎ°úÏö¥ Ïû•Î©¥ÏûÖÎãàÎã§.',
                choices: []
            });
            renderList();
            selectScene(scenes.length - 1);
        };

        window.selectScene = (index) => {
            activeIndex = index;
            renderList(); // Update Highlight
            populateInspector();
            renderPreview();
        };

        window.deleteCurrentScene = () => {
            if (!confirm("Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) return;
            scenes.splice(activeIndex, 1);
            if (scenes.length === 0) addScene();
            activeIndex = Math.max(0, activeIndex - 1);
            renderList();
            selectScene(activeIndex);
        }

        window.saveAll = async () => {
            const btn = document.querySelector('.action-btn:last-child');
            btn.innerText = "Ï†ÄÏû• Ï§ë...";

            // Convert back to DB format order
            const payload = scenes.map((s, i) => ({
                novel_id: novelId,
                title: s.text.substring(0, 20), // Summary for DB
                order_index: i,
                data: s
            }));

            const { error } = await saveScenes(novelId, payload);

            if (error) alert("Ï†ÄÏû• Ïã§Ìå®: " + error.message);
            else alert("Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!");

            btn.innerText = "üíæ Ï†ÄÏû•ÌïòÍ∏∞";
        };

        // --- Model Updates ---

        window.updateCurrentScene = (key, value) => {
            if (activeIndex < 0) return;
            scenes[activeIndex][key] = value;
            renderPreview();

            if (key === 'text') {
                // Update list thumbnail text
                const el = document.getElementById(`scene-txt-${activeIndex}`);
                if (el) el.innerText = value;
            }
        };

        // --- Choices Logic ---

        window.addChoice = () => {
            if (!scenes[activeIndex].choices) scenes[activeIndex].choices = [];
            scenes[activeIndex].choices.push({ text: "ÏÑ†ÌÉùÏßÄ", jumpIndex: activeIndex + 1 });
            populateInspector(); // Refresh list
            renderPreview();
        };

        window.updateChoice = (cIdx, key, val) => {
            scenes[activeIndex].choices[cIdx][key] = val;
            renderPreview();
        }

        window.removeChoice = (cIdx) => {
            scenes[activeIndex].choices.splice(cIdx, 1);
            populateInspector();
            renderPreview();
        }

        // --- Rendering ---

        function renderList() {
            const list = document.getElementById('sceneList');
            list.innerHTML = scenes.map((s, i) => `
                <div class="scene-item ${i === activeIndex ? 'active' : ''}" onclick="selectScene(${i})">
                    <img class="scene-thumb" src="${s.bg || 'about:blank'}">
                    <div class="scene-meta">
                        <div class="scene-idx">SCENE ${i + 1}</div>
                        <div id="scene-txt-${i}" class="scene-summary">${s.text || '(ÎÇ¥Ïö© ÏóÜÏùå)'}</div>
                    </div>
                </div>
            `).join('');

            // Auto scroll?
        }

        function populateInspector() {
            const s = scenes[activeIndex];
            document.getElementById('inBg').value = s.bg || '';
            document.getElementById('inChar').value = s.character || '';
            document.getElementById('inSpeaker').value = s.speaker || '';
            document.getElementById('inText').value = s.text || '';
            document.getElementById('inOpacity').value = s.boxOpacity !== undefined ? s.boxOpacity : 0.8;
            document.getElementById('inBoxStyle').value = s.boxStyle || '';

            // Render Choices Editor
            const cList = document.getElementById('choiceListEditor');
            const choices = s.choices || [];
            if (choices.length === 0) {
                cList.innerHTML = '<div style="font-size:12px; color:#666;">ÏÑ†ÌÉùÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§. Îã§Ïùå Ïû•Î©¥ÏúºÎ°ú ÏûêÎèô ÏßÑÌñâÎê©ÎãàÎã§.</div>';
            } else {
                cList.innerHTML = choices.map((c, i) => `
                    <div style="margin-bottom:8px; background:#111; padding:8px; border-radius:4px;">
                        <input class="form-input" style="margin-bottom:4px;" value="${c.text}" oninput="updateChoice(${i}, 'text', this.value)" placeholder="ÏÑ†ÌÉùÏßÄ ÎÇ¥Ïö©">
                        <div style="display:flex; gap:5px; align-items:center;">
                            <span style="font-size:10px; color:#888;">Ï†êÌîÑ: SCENE</span>
                            <input class="form-input" type="number" style="width:50px;" value="${c.jumpIndex}" oninput="updateChoice(${i}, 'jumpIndex', parseInt(this.value))">
                            <button onclick="removeChoice(${i})" style="margin-left:auto; background:none; border:none; color:#e74c3c; cursor:pointer;">√ó</button>
                        </div>
                    </div>
                `).join('');
            }
        }

        function renderPreview() {
            const s = scenes[activeIndex];

            // BG
            document.getElementById('pBg').style.backgroundImage = `url('${s.bg || ''}')`;

            // Char
            const pChar = document.getElementById('pChar');
            if (s.character) {
                pChar.src = s.character;
                pChar.style.display = 'block';
            } else {
                pChar.style.display = 'none';
            }

            // Dialog
            document.getElementById('pName').innerText = s.speaker || '';
            document.getElementById('pText').innerText = s.text || '';

            const dialogBox = document.getElementById('pDialogBox');
            // Custom Styles
            if (s.boxOpacity !== undefined) {
                dialogBox.style.background = `rgba(0, 0, 0, ${s.boxOpacity})`;
            } else {
                dialogBox.style.background = `rgba(0, 0, 0, 0.8)`;
            }
            if (s.boxStyle) {
                dialogBox.style.cssText += s.boxStyle;
            }

            // Preview Choices Overlay
            const pChoices = document.getElementById('pChoices');
            if (s.choices && s.choices.length > 0) {
                pChoices.style.display = 'flex';
                pChoices.innerHTML = s.choices.map(c => `
                    <div class="choice-btn-preview">${c.text}</div>
                `).join('');
            } else {
                pChoices.style.display = 'none';
            }
        }
    </script>
    <div
        style="position:absolute; bottom:20px; left:20px; right:20px; height:120px; background:rgba(0,0,0,0.8); border:2px solid #fff; border-radius:8px; padding:16px; display:flex;">
        <div style="width:100px; font-weight:700; color:#ffdd59; font-size:18px;">ÏßÄÏàò</div>
        <div style="flex:1; color:white; font-size:16px;">"Ïò§ÎäòÎèÑ Îä¶ÏóàÎÑ§? Îπ®Î¶¨ÏôÄ!"</div>
    </div>
    </div>
    </div>

    <!-- Timeline -->
    <div class="timeline-area">
        <div class="panel-header">TIMELINE</div>
        <div class="panel-content" style="background:#222;">
            <!-- Track 1: BG -->
            <div class="timeline-track">
                <div class="track-header">Î∞∞Í≤Ω (BG)</div>
                <div class="track-content">
                    <div
                        style="position:absolute; left:0; width:300px; height:100%; background:#4caf50; opacity:0.3; border:1px solid #4caf50;">
                        School_Gate.jpg</div>
                </div>
            </div>
            <!-- Track 2: Char -->
            <div class="timeline-track">
                <div class="track-header">Ï∫êÎ¶≠ÌÑ∞</div>
                <div class="track-content">
                    <div
                        style="position:absolute; left:50px; width:200px; height:100%; background:#2196f3; opacity:0.3; border:1px solid #2196f3;">
                        ÏßÄÏàò (Smile)</div>
                </div>
            </div>
            <!-- Track 3: Sound -->
            <div class="timeline-track">
                <div class="track-header">ÏÇ¨Ïö¥Îìú (BGM)</div>
                <div class="track-content">
                    <div
                        style="position:absolute; left:0; width:400px; height:100%; background:#ff9800; opacity:0.3; border:1px solid #ff9800;">
                        Bright_Morning.mp3</div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Right: Assets & Properties -->
    <div class="panel-right">
        <div class="panel-header" style="background:#007acc; color:white;">ASSET LIBRARY (Free)</div>
        <div style="height:50%; border-bottom:1px solid #000; display:flex; flex-direction:column;">
            <!-- TABS -->
            <div style="display:flex; background:#2d2d30;">
                <div style="flex:1; text-align:center; padding:8px; font-size:11px; background:#3e3e42; color:white;">
                    BGM (Free)</div>
                <div style="flex:1; text-align:center; padding:8px; font-size:11px; color:#888;">Images</div>
            </div>
            <!-- BGM LIST (Massive Mockup) -->
            <div class="panel-content">
                <div class="asset-grid">
                    <!-- Creative Commons Mocks -->
                    <div class="asset-item" onclick="selectAsset('Kevin MacLeod - Monkeys Spinning Monkeys')">
                        <div class="asset-thumb" style="background:#ff9800;">üéµ</div>
                        <div class="asset-name">Monkeys...</div>
                    </div>
                    <div class="asset-item" onclick="selectAsset('Bensound - Epic')">
                        <div class="asset-thumb" style="background:#ff9800;">üéµ</div>
                        <div class="asset-name">Epic Theme</div>
                    </div>
                    <!-- More items... -->
                </div>
            </div>
        </div>

        <!-- INSPECTOR -->
        <div class="panel-header">PROPERTIES</div>
        <div class="panel-content" style="padding:10px;">
            <div class="prop-row">
                <div class="prop-label">Ïù¥Î¶Ñ</div>
                <input class="prop-input" value="ÏßÄÏàò (Smile)">
            </div>
        </div>
    </div>
    </div>
</body>

</html>