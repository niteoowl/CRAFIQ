<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>CRAFIQ Visual Studio Pro</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module" src="js/init-supabase.js"></script>
    <!-- Use FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-dark: #121212;
            --bg-panel: #1e1e1e;
            --bg-hover: #2a2a2a;
            --accent: #1f8ce6;
            --text-main: #e0e0e0;
            --text-sub: #a0a0a0;
            --border: #333;
        }

        body {
            background: var(--bg-dark);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            font-family: 'Pretendard', sans-serif;
            margin: 0;
        }

        /* --- Header --- */
        .studio-header {
            height: 54px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            z-index: 10;
        }

        .brand-area {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .studio-logo {
            font-weight: 800;
            font-size: 16px;
            color: var(--accent);
            letter-spacing: -0.5px;
        }

        .project-title {
            font-size: 14px;
            color: var(--text-sub);
            padding-left: 12px;
            border-left: 1px solid var(--border);
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .btn {
            border: none;
            border-radius: 4px;
            padding: 8px 14px;
            font-size: 13px;
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: 0.2s;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: #157ac5;
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-sub);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
            color: var(--text-main);
        }

        /* --- Layout --- */
        .workspace {
            flex: 1;
            display: flex;
            height: calc(100vh - 54px);
        }

        /* Left: Scene List */
        .panel-left {
            width: 260px;
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            padding: 12px 16px;
            font-size: 11px;
            font-weight: 700;
            color: var(--text-sub);
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .scene-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .scene-item {
            display: flex;
            gap: 10px;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            border: 1px solid transparent;
            margin-bottom: 4px;
            background: #252525;
            transition: 0.2s;
        }

        .scene-item:hover {
            background: var(--bg-hover);
        }

        .scene-item.active {
            background: #2d3640;
            border-color: var(--accent);
        }

        .scene-thumb {
            width: 48px;
            height: 48px;
            border-radius: 4px;
            background: #000;
            object-fit: cover;
            flex-shrink: 0;
        }

        .scene-info {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .scene-idx {
            font-size: 10px;
            color: var(--accent);
            font-weight: 700;
            margin-bottom: 2px;
        }

        .scene-summary {
            font-size: 12px;
            color: var(--text-main);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Center: Stage */
        .panel-center {
            flex: 1;
            background: #0a0a0a;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .stage-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            overflow: hidden;
        }

        .stage-frame {
            width: 960px;
            height: 540px;
            background: black;
            position: relative;
            box-shadow: 0 0 60px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }

        .preview-bg {
            position: absolute;
            inset: 0;
            background-size: cover;
            background-position: center;
        }

        .preview-char {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            height: 85%;
            filter: drop-shadow(0 0 10px rgba(0, 0, 0, 0.5));
        }

        .dialog-overlay {
            position: absolute;
            bottom: 30px;
            left: 40px;
            right: 40px;
            min-height: 150px;
            background: rgba(0, 0, 0, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 24px;
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(4px);
        }

        .dialog-name {
            font-size: 20px;
            font-weight: 700;
            color: #ffdd59;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .dialog-text {
            font-size: 18px;
            line-height: 1.6;
            color: #eee;
        }

        .choice-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            z-index: 20;
        }

        .choice-btn {
            min-width: 320px;
            padding: 14px 24px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid var(--accent);
            color: var(--accent);
            border-radius: 30px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
        }

        /* Right: Inspector */
        .panel-right {
            width: 300px;
            background: var(--bg-panel);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .inspector-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .inspector-group {
            margin-bottom: 24px;
        }

        .group-label {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-sub);
            text-transform: uppercase;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .inp-row {
            margin-bottom: 12px;
        }

        .inp-label {
            display: block;
            font-size: 12px;
            color: var(--text-sub);
            margin-bottom: 6px;
        }

        .inp {
            width: 100%;
            background: #111;
            border: 1px solid #444;
            color: white;
            padding: 10px;
            border-radius: 4px;
            font-size: 13px;
        }

        .inp:focus {
            outline: 1px solid var(--accent);
            border-color: var(--accent);
        }

        textarea.inp {
            resize: vertical;
            height: 80px;
            line-height: 1.4;
        }

        /* Asset Picker */
        .asset-btn {
            width: 100%;
            padding: 8px;
            background: #333;
            border: 1px solid #444;
            color: #ccc;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .asset-btn:hover {
            background: #444;
        }

        /* BGM Selector */
        select.inp {
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23cccccc%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 8px;
            padding-right: 30px;
            appearance: none;
        }

        /* Image Helper Overlay */
        .img-helper {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #252525;
            padding: 24px;
            border-radius: 12px;
            border: 1px solid #444;
            width: 400px;
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
            display: none;
        }
    </style>
</head>

<body>

    <!-- Header -->
    <header class="studio-header">
        <div class="brand-area">
            <button onclick="location.href='dashboard.html'" class="btn btn-secondary">
                <i class="fa-solid fa-arrow-left"></i>
            </button>
            <span class="studio-logo"><i class="fa-solid fa-layer-group"></i> CRAFIQ STUDIO</span>
            <span id="novelTitle" class="project-title">Loading...</span>
        </div>
        <div class="header-actions">
            <button onclick="window.open('https://postimages.org/ko/', '_blank')" class="btn btn-secondary">
                <i class="fa-solid fa-image"></i> 이미지 업로드
            </button>
            <button onclick="saveAll()" class="btn btn-primary">
                <i class="fa-solid fa-cloud-arrow-up"></i> 저장
            </button>
        </div>
    </header>

    <div class="workspace">
        <!-- LEFT: Scenes -->
        <div class="panel-left">
            <div class="panel-header">
                SCENES
                <button onclick="addScene()"
                    style="background:none; border:none; color:var(--text-sub); cursor:pointer;">
                    <i class="fa-solid fa-plus-square"></i>
                </button>
            </div>
            <div id="sceneList" class="scene-list">
                <!-- Injected -->
            </div>
        </div>

        <!-- CENTER: Preview -->
        <div class="panel-center">
            <div class="stage-container">
                <div class="stage-frame">
                    <div id="pBg" class="preview-bg"></div>
                    <img id="pChar" class="preview-char" src="" style="display:none;">

                    <div id="pDialogBox" class="dialog-overlay">
                        <div id="pName" class="dialog-name">Name</div>
                        <div id="pText" class="dialog-text">Text...</div>
                    </div>

                    <div id="pChoices" class="choice-overlay" style="display:none;">
                        <!-- Buttons -->
                    </div>
                </div>
            </div>
            <div style="padding:10px; text-align:center; color:#555; font-size:12px;">
                1920x1080 HD Resolution Preview
            </div>
        </div>

        <!-- RIGHT: Inspector -->
        <div class="panel-right">
            <div class="panel-header">INSPECTOR</div>
            <div id="inspector" class="inspector-content">
                <!-- Group: BGM -->
                <div class="inspector-group">
                    <div class="group-label"><i class="fa-solid fa-music"></i> 배경음악 (BGM)</div>
                    <select id="inBgm" class="inp" onchange="updateScene('bgm', this.value)">
                        <option value="">없음</option>
                        <option value="https://t1.daumcdn.net/cfile/tistory/990D774B5DA925FD24">B001 - 경쾌/약간 어두운
                        </option>
                        <option value="https://t1.daumcdn.net/cfile/tistory/9932104A5DA92C792C">B002 - 경쾌/어두운</option>
                        <option value="https://t1.daumcdn.net/cfile/tistory/999201355DA98F741D">B003 - 경쾌/피아노/재즈
                        </option>
                        <option value="https://t1.daumcdn.net/cfile/tistory/99E0B03D5DA9917738">B004 - 경쾌/빠른/전자</option>
                        <option value="https://t1.daumcdn.net/cfile/tistory/993B8C485DA9930A26">B005 - 경쾌/오락</option>
                        <option value="https://t1.daumcdn.net/cfile/tistory/9980B83A5DA994ED06">B006 - 왈츠</option>
                        <option value="https://t1.daumcdn.net/cfile/tistory/9939ED4D5DA997780C">B007 - 보통/피아노</option>
                        <option value="https://t1.daumcdn.net/cfile/tistory/994C4C4B5DA99B9126">B008 - 긍정/진취적</option>
                        <option value="https://t1.daumcdn.net/cfile/tistory/99C3B0465DA99E4E2E">B009 - 차분/피아노</option>
                        <option value="https://t1.daumcdn.net/cfile/tistory/99896A465DB1ABF921">B027 - 비교적 조용한</option>
                        <option value="https://t1.daumcdn.net/cfile/tistory/99FEC7335DB5A5CB33">B030 - 차분한/전자음</option>
                        <option value="https://t1.daumcdn.net/cfile/tistory/99299C3A5F75A3812A">C039 - 희망/차분</option>
                        <!-- Added a selection of the provided list -->
                    </select>
                </div>

                <!-- Group: Background -->
                <div class="inspector-group">
                    <div class="group-label"><i class="fa-solid fa-image"></i> 배경 (Background)</div>
                    <div class="inp-row">
                        <label class="inp-label">이미지 URL</label>
                        <input id="inBg" class="inp" oninput="updateScene('bg', this.value)" placeholder="https://...">
                        <button onclick="openImgHelp('bg')" class="asset-btn">이미지 링크 가져오기</button>
                    </div>
                </div>

                <!-- Group: Character -->
                <div class="inspector-group">
                    <div class="group-label"><i class="fa-solid fa-user"></i> 캐릭터 (Character)</div>
                    <div class="inp-row">
                        <label class="inp-label">이미지 URL (투명 배경 PNG 권장)</label>
                        <input id="inChar" class="inp" oninput="updateScene('character', this.value)"
                            placeholder="https://...">
                        <button onclick="openImgHelp('char')" class="asset-btn">이미지 링크 가져오기</button>
                    </div>
                </div>

                <!-- Group: Script -->
                <div class="inspector-group">
                    <div class="group-label"><i class="fa-solid fa-comment-dots"></i> 대사 (Script)</div>
                    <div class="inp-row">
                        <label class="inp-label">화자 (Speaker)</label>
                        <input id="inSpeaker" class="inp" oninput="updateScene('speaker', this.value)">
                    </div>
                    <div class="inp-row">
                        <label class="inp-label">내용 (Text)</label>
                        <textarea id="inText" class="inp" style="height:100px;"
                            oninput="updateScene('text', this.value)"></textarea>
                    </div>
                </div>

                <!-- Group: Choices -->
                <div class="inspector-group">
                    <div class="group-label" style="justify-content:space-between;">
                        <span><i class="fa-solid fa-list-ul"></i> 선택지 (Choices)</span>
                        <button onclick="addChoice()"
                            style="background:none; border:none; color:var(--accent); cursor:pointer;">+ 추가</button>
                    </div>
                    <div id="choiceEditor">
                        <!-- Dynamic -->
                    </div>
                </div>

                <div class="inspector-group" style="border-top:1px solid #333; padding-top:20px;">
                    <button onclick="deleteScene()"
                        style="width:100%; padding:10px; background:#e74c3c; border:none; color:white; border-radius:4px; font-weight:bold; cursor:pointer;">이
                        장면 삭제</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Helper Modal -->
    <div id="imgHelper" class="img-helper">
        <h3 style="color:white; margin-bottom:12px;">이미지 업로드 가이드</h3>
        <p style="font-size:13px; color:#aaa; line-height:1.5; margin-bottom:20px;">
            1. 상단 메뉴의 <b>'이미지 업로드'</b> 버튼을 눌러 PostImages 사이트를 여세요.<br>
            2. 이미지를 업로드한 후, <b>'직접 링크(Direct Link)'</b> 주소를 복사하세요.<br>
            3. 아래 칸에 붙여넣기 하면 자동으로 적용됩니다.
        </p>
        <input id="pasteImg" class="inp" placeholder="여기에 주소를 붙여넣으세요..." style="margin-bottom:12px;">
        <div style="display:flex; justify-content:flex-end; gap:8px;">
            <button onclick="document.getElementById('imgHelper').style.display='none'"
                class="btn btn-secondary">닫기</button>
            <button onclick="applyPastedImg()" class="btn btn-primary">적용하기</button>
        </div>
    </div>

    <script type="module">
        import { getNovelById, getScenes, saveScenes } from './js/data.js';

        let novelId = null;
        let scenes = [];
        let activeIdx = 0;
        let targetField = ''; // for img helper

        window.init = async () => {
            const params = new URLSearchParams(window.location.search);
            novelId = params.get('id');
            if (!novelId) { alert("잘못된 접근입니다."); location.href = 'dashboard.html'; return; }

            // Load Text Data
            const { data: novel } = await getNovelById(novelId);
            if (novel) document.getElementById('novelTitle').innerText = novel.title;

            // Load Scenes
            const { data: list } = await getScenes(novelId);
            if (list && list.length > 0) {
                // Parse format
                scenes = list.map(item => ({
                    id: item.id,
                    ...item.data
                }));
            } else {
                // Init first scene
                addScene();
            }

            renderList();
            selectScene(0);
        }

        /* --- LOGIC --- */

        window.addScene = () => {
            scenes.push({
                bg: 'https://images.unsplash.com/photo-1518173946687-a4c8892bbd9f?w=1000',
                character: '',
                speaker: '???',
                text: '새로운 장면입니다.',
                bgm: '',
                choices: []
            });
            renderList();
            selectScene(scenes.length - 1);
        }

        window.selectScene = (idx) => {
            if (idx < 0 || idx >= scenes.length) return;
            activeIdx = idx;
            renderList();
            renderInspector();
            renderStage();
        }

        window.updateScene = (key, val) => {
            scenes[activeIdx][key] = val;
            renderStage();
            if (key === 'text') {
                const el = document.getElementById(`desc-${activeIdx}`);
                if (el) el.innerText = val;
            }
        }

        window.deleteScene = () => {
            if (!confirm("정말 삭제하시겠습니까?")) return;
            scenes.splice(activeIdx, 1);
            if (scenes.length === 0) addScene();
            activeIdx = Math.max(0, activeIdx - 1);
            renderList();
            selectScene(activeIdx);
        }

        window.saveAll = async () => {
            // Transform to DB
            const payload = scenes.map((s, i) => ({
                novel_id: novelId,
                title: s.text.substring(0, 20),
                order_index: i,
                data: s
            }));
            const { error } = await saveScenes(novelId, payload);
            if (error) alert(error.message);
            else alert("저장되었습니다.");
        }

        /* --- INSPECTOR & CHOICES --- */

        window.addChoice = () => {
            if (!scenes[activeIdx].choices) scenes[activeIdx].choices = [];
            scenes[activeIdx].choices.push({ text: "선택지 내용", jumpIndex: activeIdx + 1 });
            renderInspector();
            renderStage();
        }

        window.updateChoice = (cIdx, key, val) => {
            scenes[activeIdx].choices[cIdx][key] = val;
            renderStage();
        }

        window.removeChoice = (cIdx) => {
            scenes[activeIdx].choices.splice(cIdx, 1);
            renderInspector();
            renderStage();
        }

        /* --- RENDER --- */

        function renderList() {
            const list = document.getElementById('sceneList');
            list.innerHTML = scenes.map((s, i) => `
                <div class="scene-item ${i === activeIdx ? 'active' : ''}" onclick="selectScene(${i})">
                    <img class="scene-thumb" src="${s.bg || ''}">
                    <div class="scene-info">
                        <div class="scene-idx">SCENE ${i + 1}</div>
                        <div id="desc-${i}" class="scene-summary">${s.text}</div>
                    </div>
                </div>
            `).join('');
        }

        function renderInspector() {
            const s = scenes[activeIdx];
            document.getElementById('inBg').value = s.bg || '';
            document.getElementById('inChar').value = s.character || '';
            document.getElementById('inSpeaker').value = s.speaker || '';
            document.getElementById('inText').value = s.text || '';
            document.getElementById('inBgm').value = s.bgm || '';

            // Choices
            const cDiv = document.getElementById('choiceEditor');
            if (!s.choices || s.choices.length === 0) {
                cDiv.innerHTML = '<div style="font-size:12px; color:#666;">선택지가 없습니다 (자동 진행).</div>';
            } else {
                cDiv.innerHTML = s.choices.map((c, i) => `
                    <div style="background:#1a1a1a; padding:10px; border-radius:4px; margin-bottom:8px;">
                        <input class="inp" style="margin-bottom:4px;" value="${c.text}" oninput="updateChoice(${i}, 'text', this.value)" placeholder="선택지 텍스트">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                             <div style="font-size:11px; color:#888;">점프: SCENE ${c.jumpIndex + 1}</div>
                             <input type="number" class="inp" style="width:60px; padding:4px;" value="${c.jumpIndex}" oninput="updateChoice(${i}, 'jumpIndex', parseInt(this.value))">
                             <button onclick="removeChoice(${i})" style="color:#e74c3c; background:none; border:none; cursor:pointer;">삭제</button>
                        </div>
                    </div>
                `).join('');
            }
        }

        function renderStage() {
            const s = scenes[activeIdx];
            // BG & Char
            document.getElementById('pBg').style.backgroundImage = `url('${s.bg}')`;
            if (s.character) {
                document.getElementById('pChar').style.display = 'block';
                document.getElementById('pChar').src = s.character;
            } else {
                document.getElementById('pChar').style.display = 'none';
            }

            // Dialog
            document.getElementById('pName').innerText = s.speaker;
            document.getElementById('pText').innerText = s.text;

            // Choices
            const cDiv = document.getElementById('pChoices');
            if (s.choices && s.choices.length > 0) {
                cDiv.style.display = 'flex';
                cDiv.innerHTML = s.choices.map(c => `<div class="choice-btn">${c.text}</div>`).join('');
                document.getElementById('pDialogBox').style.opacity = '0.3';
            } else {
                cDiv.style.display = 'none';
                document.getElementById('pDialogBox').style.opacity = '1';
            }
        }

        /* --- HELPERS --- */
        window.openImgHelp = (target) => {
            targetField = target;
            document.getElementById('imgHelper').style.display = 'block';
            document.getElementById('pasteImg').focus();
        }

        window.applyPastedImg = () => {
            const val = document.getElementById('pasteImg').value;
            if (!val) return;

            if (targetField === 'bg') {
                updateScene('bg', val);
                document.getElementById('inBg').value = val;
            } else {
                updateScene('character', val);
                document.getElementById('inChar').value = val;
            }
            document.getElementById('imgHelper').style.display = 'none';
            document.getElementById('pasteImg').value = '';
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>