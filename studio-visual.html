<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>CRAFIQ INFINITY ENGINE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module" src="js/init-supabase.js"></script>

    <style>
        /* --- INFINITY THEME (Flat, Clean, Dark) --- */
        :root {
            --bg-body: #111;
            --bg-panel: #1e1e1e;
            --bg-header: #252525;
            --bg-input: #111;
            --main: #3b82f6;
            /* Blue for Pro */
            --easy: #10b981;
            /* Green for Easy */
            --border: #333;
            --text: #e5e5e5;
            --text-dim: #888;
        }

        * {
            box-sizing: border-box;
            outline: none;
            user-select: none;
        }

        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            background: var(--bg-body);
            color: var(--text);
            font-family: 'Gulim', 'Pretendard', sans-serif;
            /* Requested Gulim */
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* ZOOM CONTAINER */
        #app-scale-wrap {
            width: 1600px;
            height: 900px;
            /* Fixed Base Resolution */
            background: var(--bg-panel);
            box-shadow: 0 0 100px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            transform-origin: center center;
            overflow: hidden;
            border: 1px solid #444;
        }

        /* COMMON UI */
        .btn {
            background: #2a2a2a;
            color: #ccc;
            border: 1px solid #3a3a3a;
            padding: 6px 14px;
            font-size: 12px;
            cursor: pointer;
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-family: 'Gulim', sans-serif;
        }

        .btn:hover {
            background: #3a3a3a;
            color: white;
        }

        .btn.primary {
            background: var(--main);
            border-color: var(--main);
            color: white;
        }

        .btn.easy {
            background: var(--easy);
            border-color: var(--easy);
            color: white;
        }

        .inp {
            background: var(--bg-input);
            border: 1px solid #333;
            color: white;
            padding: 6px;
            font-size: 12px;
            border-radius: 4px;
            width: 100%;
            font-family: 'Gulim', sans-serif;
        }

        .inp:focus {
            border-color: var(--main);
        }

        .panel-head {
            height: 36px;
            background: var(--bg-header);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 12px;
            font-weight: bold;
            font-size: 12px;
            justify-content: space-between;
            color: #ddd;
        }

        /* LAYOUT */
        #topbar {
            height: 48px;
            background: #181818;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
        }

        /* CONTENT SPLIT */
        #main-content {
            flex: 1;
            display: grid;
            grid-template-columns: 280px 1fr 340px;
            overflow: hidden;
        }

        /* LEFT: MANAGER */
        #left-col {
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        /* CENTER: STAGE */
        #center-col {
            background: #000;
            display: flex;
            flex-direction: column;
        }

        #stage-area {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background-image: radial-gradient(#333 1px, transparent 1px);
            background-size: 20px 20px;
            position: relative;
        }

        #game-canvas {
            width: 1280px;
            height: 720px;
            background: #000;
            position: relative;
            box-shadow: 0 0 50px black;
            overflow: hidden;
        }

        /* TIMELINE (PRO MODE) */
        #timeline-area {
            height: 280px;
            background: #161616;
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        /* SCRIPT EDITOR (EASY MODE) */
        #script-area {
            flex: 1;
            background: #111;
            padding: 20px;
            overflow-y: auto;
            display: none;
        }

        .script-line {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
            align-items: center;
        }

        .s-name {
            width: 100px;
            text-align: right;
            color: #f1c40f;
            font-weight: bold;
        }

        .s-text {
            flex: 1;
            background: #222;
            border: 1px solid #333;
            color: #eee;
            padding: 8px;
            border-radius: 4px;
        }

        /* RIGHT: INSPECTOR */
        #right-col {
            background: var(--bg-panel);
            border-left: 1px solid var(--border);
            overflow-y: auto;
        }

        /* TAB BAR */
        .tabs {
            display: flex;
            background: #222;
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 8px;
            cursor: pointer;
            color: #777;
            border-bottom: 2px solid transparent;
            font-size: 11px;
        }

        .tab.active {
            color: white;
            border-bottom-color: var(--main);
            background: #2a2a2a;
        }

        /* HELPERS */
        .modal-over {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 999;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .modal {
            width: 500px;
            background: #222;
            border: 1px solid #444;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 20px 50px black;
        }

        /* CLASSES */
        .t-bg {
            color: #2ecc71;
        }

        .t-char {
            color: #3498db;
        }

        .t-txt {
            color: #f1c40f;
        }
    </style>
</head>

<body>

    <div id="app-scale-wrap">

        <!-- HEADER -->
        <div id="topbar">
            <div style="display:flex; align-items:center; gap:20px;">
                <span style="font-size:18px; font-weight:900; color:white;"><i class="fa-solid fa-infinity"></i>
                    INFINITY ENGINE</span>
                <div style="background:#333; padding:4px; border-radius:20px; display:flex;">
                    <button id="mode-easy" class="btn easy" style="border-radius:16px;"
                        onclick="Engine.setMode('EASY')">âœ¨ ì´ˆë³´ì ëª¨ë“œ</button>
                    <button id="mode-pro" class="btn"
                        style="border-radius:16px; border:none; background:transparent; opacity:0.5;"
                        onclick="Engine.setMode('PRO')">ğŸ› ï¸ ì „ë¬¸ê°€ ëª¨ë“œ</button>
                </div>
            </div>

            <div style="display:flex; gap:10px;">
                <button class="btn" onclick="Nav.exit()"><i class="fa-solid fa-house"></i> ë‚˜ê°€ê¸°</button>
                <button class="btn" onclick="Project.save()"><i class="fa-solid fa-floppy-disk"></i> ì €ì¥</button>
                <button class="btn primary" onclick="Project.play()"><i class="fa-solid fa-play"></i> ì‹¤í–‰</button>
            </div>
        </div>

        <!-- MAIN -->
        <div id="main-content">

            <!-- 1. LEFT: ASSETS & SCENES -->
            <div id="left-col">
                <div class="tabs">
                    <div id="tab-scene" class="tab active" onclick="UI.tab('scene')">ì¥ë©´ (Scenes)</div>
                    <div id="tab-asset" class="tab" onclick="UI.tab('asset')">ìì‚° (Assets)</div>
                    <div id="tab-ui" class="tab" onclick="UI.tab('ui')">UI ì„¤ì •</div>
                </div>

                <!-- SCENE LIST -->
                <div id="p-scene" class="flex-col" style="flex:1;">
                    <div class="panel-head">
                        <span>ì¥ë©´ ëª©ë¡</span>
                        <button class="btn" style="padding:2px 8px;" onclick="Scene.add()"><i
                                class="fa-solid fa-plus"></i> ì¶”ê°€</button>
                    </div>
                    <div id="list-scenes" style="padding:10px; overflow-y:auto; flex:1;"></div>
                </div>

                <!-- ASSET LIST -->
                <div id="p-asset" class="flex-col" style="flex:1; display:none;">
                    <div style="padding:10px;">
                        <button class="btn primary" style="width:100%; justify-content:center; margin-bottom:10px;"
                            onclick="Utils.modal('import')">
                            <i class="fa-solid fa-cloud-arrow-down"></i> ì´ë¯¸ì§€/ì˜¤ë””ì˜¤ ë§í¬ ê°€ì ¸ì˜¤ê¸°
                        </button>
                        <div style="color:#666; font-size:11px; text-align:center;">
                            PostImages ë“±ì˜ URLì„ ì…ë ¥í•˜ì„¸ìš”.<br>
                            ë“œë˜ê·¸ ì•¤ ë“œë¡­ìœ¼ë¡œ ë„£ì„ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
                        </div>
                    </div>
                </div>

                <!-- UI EDIT -->
                <div id="p-ui" class="flex-col" style="flex:1; display:none; padding:10px;">
                    <label style="color:#888; display:block; margin-bottom:4px;">ëŒ€í™”ì°½ ìŠ¤íƒ€ì¼</label>
                    <select class="inp" style="margin-bottom:10px;">
                        <option>ê¸°ë³¸ (Dark)</option>
                        <option>ë°ìŒ (Light)</option>
                        <option>íŒíƒ€ì§€ (Fantasy)</option>
                        <option>SF (Cyber)</option>
                    </select>

                    <label style="color:#888; display:block; margin-bottom:4px;">í°íŠ¸</label>
                    <select class="inp" style="margin-bottom:10px;">
                        <option>êµ´ë¦¼ì²´ (Gulim)</option>
                        <option>í”„ë¦¬í…ë‹¤ë“œ (Pretendard)</option>
                        <option>ë‚˜ëˆ”ê³ ë”• (Nanum)</option>
                        <option>ë°”íƒ•ì²´ (Batang)</option>
                    </select>
                </div>
            </div>

            <!-- 2. CENTER: STAGE -->
            <div id="center-col">

                <!-- SCRIPT EDITOR (EASY) -->
                <div id="script-area">
                    <h2 style="color:var(--easy); margin-top:0;">ğŸ“œ ì‹œë‚˜ë¦¬ì˜¤ ëª¨ë“œ</h2>
                    <p style="color:#666; font-size:12px;">ë³µì¡í•œ íƒ€ì„ë¼ì¸ ì—†ì´, ëŒ€ë³¸ ì“°ë“¯ì´ ê²Œì„ì„ ë§Œë“œì„¸ìš”.</p>
                    <div id="script-lines">
                        <!-- Generated Lines -->
                    </div>
                    <button class="btn easy" style="width:100%; justify-content:center; margin-top:20px;"
                        onclick="EasyMode.addLine()">+ ëŒ€ì‚¬ ì¶”ê°€</button>
                </div>

                <!-- GAME STAGE (VISUAL) -->
                <div id="stage-area">
                    <div id="game-canvas">
                        <div id="r-bg"
                            style="position:absolute; inset:0; background-size:cover; background-position:center;">
                        </div>
                        <div id="r-chars" style="position:absolute; inset:0;"></div>

                        <!-- UI PREVIEW -->
                        <div id="r-ui" style="position:absolute; inset:0; pointer-events:none;">
                            <div id="r-box"
                                style="position:absolute; bottom:50px; left:100px; right:100px; height:180px; background:rgba(0,0,0,0.8); border:2px solid #555; border-radius:10px; padding:30px;">
                                <div id="r-name"
                                    style="color:#f1c40f; font-weight:bold; font-size:24px; margin-bottom:10px;">ì´ë¦„
                                </div>
                                <div id="r-text" style="color:#eee; font-size:20px; line-height:1.5;">ëŒ€ì‚¬ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TIMELINE (PRO) -->
                <div id="timeline-area" style="display:none;">
                    <div class="panel-head">
                        <span>íƒ€ì„ë¼ì¸ (Timeline)</span>
                        <div style="display:flex; gap:4px;">
                            <button class="btn" style="padding:2px 8px;" onclick="Timeline.addClip('bg')"><i
                                    class="fa-solid fa-image t-bg"></i> ë°°ê²½</button>
                            <button class="btn" style="padding:2px 8px;" onclick="Timeline.addClip('char')"><i
                                    class="fa-solid fa-user t-char"></i> ìºë¦­í„°</button>
                            <button class="btn" style="padding:2px 8px;" onclick="Timeline.addClip('text')"><i
                                    class="fa-solid fa-comment t-txt"></i> ëŒ€ì‚¬</button>
                        </div>
                    </div>
                    <div id="tl-tracks" style="padding:10px; overflow:auto;">
                        <!-- Tracks -->
                    </div>
                </div>
            </div>

            <!-- 3. RIGHT: INSPECTOR -->
            <div id="right-col">
                <div class="panel-head">ì†ì„± (Inspector)</div>
                <div id="inspector-body" style="padding:10px;">
                    <div style="text-align:center; color:#555; margin-top:50px;">ì„ íƒëœ í•­ëª© ì—†ìŒ</div>
                </div>
            </div>

        </div>
    </div>

    <!-- MODAL IMPORT -->
    <div id="modal-import" class="modal-over">
        <div class="modal">
            <h3>ì´ë¯¸ì§€/ì˜¤ë””ì˜¤ URL ì…ë ¥</h3>
            <input id="inp-url" class="inp" placeholder="https://..."
                style="font-size:14px; padding:10px; margin:20px 0;">
            <div style="text-align:right; display:flex; justify-content:flex-end; gap:10px;">
                <button class="btn" onclick="Utils.modalClose('import')">ì·¨ì†Œ</button>
                <button class="btn primary" onclick="Utils.applyUrl()">ì ìš©í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { getNovelById, getScenes, saveScenes } from './js/data.js';

        /* 
            INFINITY ENGINE LOGIC
            Supports both Easy (Linear List) and Pro (Timeline Tracks) data models.
            Actually, Easy mode just abstracts the Timeline. 
            Easy Mode = Auto-generates Tracks.
        */

        const State = {
            mode: 'EASY', // EASY | PRO
            project: { id: null },
            scenes: [],
            sceneId: null,
            clipId: null
        };

        const Engine = {
            init: async () => {
                // 1. Auto Scale
                Engine.resize();
                window.addEventListener('resize', Engine.resize);

                // 2. Load
                const p = new URLSearchParams(location.search);
                const id = p.get('id');
                if (!id) return alert("ID ì—†ìŒ");
                State.project.id = id;

                const { data: scenes } = await getScenes(id);
                if (scenes && scenes.length) {
                    State.scenes = scenes.map(s => ({
                        id: s.id,
                        name: s.title,
                        tracks: s.data.tracks || Timeline.defaultTracks()
                    }));
                } else {
                    Scene.add();
                }

                Render.scenes();
                if (State.scenes.length) Scene.select(State.scenes[0].id);
            },

            resize: () => {
                const h = window.innerHeight;
                const baseH = 900;
                // Don't upscale too much, but downscale unlimited
                let s = h / baseH;
                if (s > 1) s = 1;
                const el = document.getElementById('app-scale-wrap');
                el.style.transform = `scale(${s})`;
                // Compensate margin if needed
            },

            setMode: (m) => {
                State.mode = m;
                document.getElementById('mode-easy').className = `btn ${m === 'EASY' ? 'easy' : ''}`;
                document.getElementById('mode-easy').style.opacity = m === 'EASY' ? 1 : 0.5;
                document.getElementById('mode-pro').className = `btn ${m === 'PRO' ? 'primary' : ''}`;
                document.getElementById('mode-pro').style.opacity = m === 'PRO' ? 1 : 0.5;

                // Toggle UI
                if (m === 'EASY') {
                    document.getElementById('stage-area').style.display = 'none';
                    document.getElementById('timeline-area').style.display = 'none';
                    document.getElementById('script-area').style.display = 'block';
                    EasyMode.render();
                } else {
                    document.getElementById('stage-area').style.display = 'flex';
                    document.getElementById('timeline-area').style.display = 'flex';
                    document.getElementById('script-area').style.display = 'none';
                    Timeline.render();
                }
            }
        };

        const Scene = {
            add: () => {
                State.scenes.push({
                    id: Math.random().toString(36).substr(2, 9),
                    name: `ì¥ë©´ ${State.scenes.length + 1}`,
                    tracks: Timeline.defaultTracks()
                });
                Render.scenes();
            },
            select: (id) => {
                State.sceneId = id;
                Render.scenes();
                if (State.mode === 'PRO') {
                    Timeline.render();
                    Preview.render();
                } else {
                    EasyMode.render();
                }
            },
            active: () => State.scenes.find(s => s.id === State.sceneId)
        };

        const Timeline = {
            defaultTracks: () => [
                { type: 'bg', name: 'ë°°ê²½', clips: [] },
                { type: 'char', name: 'ìºë¦­í„°', clips: [] },
                { type: 'text', name: 'ëŒ€ì‚¬', clips: [] }
            ],

            addClip: (type) => {
                const s = Scene.active();
                const track = s.tracks.find(t => t.type === type);
                if (!track) return;

                // Find end time
                let start = 0;
                track.clips.forEach(c => { if (c.start + c.dur > start) start = c.start + c.dur; });

                track.clips.push({
                    id: Math.random().toString(36).substr(2, 9),
                    type,
                    start,
                    dur: 2,
                    data: Timeline.defaults(type)
                });
                Timeline.render();
            },

            defaults: (t) => {
                if (t === 'bg') return { url: '' };
                if (t === 'char') return { url: '', x: 0.5, y: 1, scale: 1 };
                if (t === 'text') return { speaker: 'ì´ë¦„', text: 'ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.' };
                return {};
            },

            render: () => {
                const s = Scene.active();
                if (!s) return;
                const el = document.getElementById('tl-tracks');
                el.innerHTML = '';

                s.tracks.forEach(t => {
                    const row = document.createElement('div');
                    row.style.marginBottom = '4px';
                    row.innerHTML = `<div style="background:#222; padding:4px; font-size:11px; color:#888;">${t.name}</div>`;

                    const lane = document.createElement('div');
                    lane.style.background = '#111'; lane.style.height = '30px'; lane.style.position = 'relative';
                    lane.style.border = '1px solid #333';

                    t.clips.forEach(c => {
                        const clip = document.createElement('div');
                        clip.style.position = 'absolute';
                        clip.style.left = (c.start * 30) + 'px'; // 1s = 30px
                        clip.style.width = (c.dur * 30) + 'px';
                        clip.style.height = '100%';
                        clip.style.border = '1px solid black';

                        let col = '#555';
                        if (c.type === 'bg') col = '#27ae60';
                        if (c.type === 'char') col = '#2980b9';
                        if (c.type === 'text') col = '#e67e22';

                        clip.style.background = col;
                        clip.style.opacity = 0.8;
                        if (c.id === State.clipId) clip.style.border = '2px solid white';

                        clip.onclick = (e) => {
                            e.stopPropagation();
                            State.clipId = c.id;
                            Timeline.render();
                            Inspector.render();
                            Preview.render(); // Update visual to show chosen clip
                        };
                        lane.appendChild(clip);
                    });
                    row.appendChild(lane);
                    el.appendChild(row);
                });
            }
        };

        const EasyMode = {
            render: () => {
                const s = Scene.active();
                // We primarily allow editing "Text" tracks here, 
                // maybe simple cues for BG/Char?
                // For simplicity, just list all clips sorted by time.

                const all = [];
                s.tracks.forEach(t => t.clips.forEach(c => all.push(c)));
                all.sort((a, b) => a.start - b.start);

                const el = document.getElementById('script-lines');
                el.innerHTML = all.map(c => `
                    <div class="script-line" onclick="State.clipId='${c.id}'; Inspector.render();">
                        <div style="width:60px; font-size:10px; color:#555;">${c.type.toUpperCase()}</div>
                        ${EasyMode.content(c)}
                        <button class="btn" onclick="Timeline.remove('${c.id}')">X</button>
                    </div>
                `).join('');
            },

            content: (c) => {
                if (c.type === 'text') return `<input class="inp s-name" value="${c.data.speaker}"><input class="inp s-text" value="${c.data.text}">`;
                if (c.type === 'bg') return `<div style="flex:1; color:#2ecc71;">ë°°ê²½ ë³€ê²½: ${c.data.url ? 'ì„¤ì •ë¨' : 'ë¹„ì–´ìˆìŒ'}</div>`;
                if (c.type === 'char') return `<div style="flex:1; color:#3498db;">ìºë¦­í„° ë“±ì¥: ${c.data.url ? 'ì„¤ì •ë¨' : 'ë¹„ì–´ìˆìŒ'}</div>`;
                return '';
            },

            addLine: () => {
                // Add text clip at end
                Timeline.addClip('text');
                EasyMode.render();
            }
        };

        const Inspector = {
            render: () => {
                const s = Scene.active();
                let clip = null;
                s.tracks.forEach(t => { const f = t.clips.find(x => x.id === State.clipId); if (f) clip = f; });

                const el = document.getElementById('inspector-body');
                if (!clip) return el.innerHTML = '<div style="text-align:center;color:#555;">ì„ íƒ ì—†ìŒ</div>';

                let h = `<h3 style="margin-top:0">${clip.type} ì†ì„±</h3>`;

                const field = (l, k) => `<div style="margin-bottom:8px;"><label style="font-size:11px; color:#888;">${l}</label><input class="inp" value="${clip.data[k] || ''}" oninput="Inspector.update('${k}', this.value)"></div>`;

                if (clip.type === 'text') {
                    h += field('í™”ì ì´ë¦„', 'speaker');
                    h += field('ëŒ€ì‚¬ ë‚´ìš©', 'text');
                }
                if (clip.type === 'bg' || clip.type === 'char') {
                    h += field('ì´ë¯¸ì§€ URL', 'url');
                    h += `<button class="btn primary" style="width:100%;" onclick="Utils.modal('import')">ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸°</button>`;
                }
                if (clip.type === 'char') {
                    h += field('X ì¢Œí‘œ (0~1)', 'x');
                    h += field('Y ì¢Œí‘œ (0~1)', 'y');
                    h += field('í¬ê¸° (Scale)', 'scale');
                }

                el.innerHTML = h;
            },
            update: (k, v) => {
                const s = Scene.active();
                let clip = null;
                s.tracks.forEach(t => { const f = t.clips.find(x => x.id === State.clipId); if (f) clip = f; });
                if (clip) {
                    clip.data[k] = v;
                    if (State.mode === 'PRO') Preview.render();
                }
            }
        };

        const Preview = {
            render: () => {
                const s = Scene.active();
                // Simple snapshot of all clips
                document.getElementById('r-bg').style.backgroundImage = '';
                document.getElementById('r-chars').innerHTML = '';

                s.tracks.forEach(t => {
                    t.clips.forEach(c => {
                        if (c.type === 'bg') document.getElementById('r-bg').style.backgroundImage = `url('${c.data.url}')`;
                        if (c.type === 'char') {
                            const img = document.createElement('img');
                            img.src = c.data.url;
                            img.style.position = 'absolute';
                            img.style.left = (c.data.x * 100) + '%';
                            img.style.top = (c.data.y * 100) + '%';
                            img.style.transform = `translate(-50%, -100%) scale(${c.data.scale})`;
                            document.getElementById('r-chars').appendChild(img);
                        }
                    })
                });
            }
        };

        const Render = {
            scenes: () => {
                document.getElementById('list-scenes').innerHTML = State.scenes.map(s => `
                    <div style="padding:8px; cursor:pointer; background:${s.id === State.sceneId ? '#333' : 'transparent'}; color:${s.id === State.sceneId ? 'white' : '#888'};" onclick="Scene.select('${s.id}')">
                        <i class="fa-solid fa-film"></i> ${s.name}
                    </div>
                `).join('');
            }
        };

        const Utils = {
            modal: (id) => document.getElementById(`modal-${id}`).style.display = 'flex',
            modalClose: (id) => document.getElementById(`modal-${id}`).style.display = 'none',
            applyUrl: () => {
                const url = document.getElementById('inp-url').value;
                if (url) Inspector.update('url', url);
                Utils.modalClose('import');
                // Refresh
                if (State.mode === 'PRO') Preview.render();
                Inspector.render();
            }
        }

        const Nav = { exit: () => location.href = 'dashboard.html' };
        const Project = {
            save: async () => {
                const payload = State.scenes.map((s, i) => ({ novel_id: State.project.id, title: s.name, order_index: i, data: { tracks: s.tracks } }));
                await saveScenes(State.project.id, payload);
                alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
            },
            play: () => window.open(`play.html?id=${State.project.id}`)
        };

        // EXPORTS
        window.Engine = Engine;
        window.Scene = Scene;
        window.Timeline = Timeline;
        window.EasyMode = EasyMode;
        window.Inspector = Inspector;
        window.Preview = Preview;
        window.Utils = Utils;
        window.Nav = Nav;
        window.Project = Project;
        window.UI = {
            tab: (id) => {
                ['scene', 'asset', 'ui'].forEach(x => {
                    document.getElementById(`tab-${x}`).className = `tab ${x === id ? 'active' : ''}`;
                    document.getElementById(`p-${x}`).style.display = x === id ? 'flex' : 'none';
                })
            }
        };

        window.addEventListener('DOMContentLoaded', Engine.init);
    </script>
</body>

</html>