<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRAFIQ Web Novel Studio</title>
    <link rel="stylesheet" as="style" crossOrigin
        href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <link rel="stylesheet" href="style.css">

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module" src="js/turbo-router.js"></script>

    <script type="module">
        import { getNovelById, getChapters, createChapter, saveChapterContent } from './js/data.js';

        // State
        let currentNovelId = null;
        let currentChapterId = null;

        window.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            currentNovelId = params.get('id');

            if (!currentNovelId) {
                alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.");
                window.location.href = 'dashboard.html';
                return;
            }

            // Load Info
            const { data: novel, error } = await getNovelById(currentNovelId);
            if (novel) document.getElementById('novelTitle').innerText = novel.title;

            // Load Chapters
            loadChapterList();
        });

        async function loadChapterList() {
            const listEl = document.getElementById('chapterList');
            const { data: chapters, error } = await getChapters(currentNovelId);

            listEl.innerHTML = ''; // Clear
            if (chapters && chapters.length > 0) {
                chapters.forEach(ch => {
                    const div = document.createElement('div');
                    div.className = `chapter-list-item ${currentChapterId === ch.id ? 'active' : ''}`;
                    div.innerText = ch.title;
                    div.onclick = () => loadChapter(ch);
                    listEl.appendChild(div);
                });
                // Load first chapter if none selected
                if (!currentChapterId) loadChapter(chapters[0]);
            } else {
                listEl.innerHTML = '<div style="padding:10px; color:#666;">ì±•í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
        }

        async function loadChapter(chapter) {
            currentChapterId = chapter.id;
            document.getElementById('editorArea').innerText = chapter.content || ""; // Simple text load

            // Update active state
            document.querySelectorAll('.chapter-list-item').forEach(el => el.classList.remove('active'));
            // (In a real app, I'd map elements to IDs, but this is a quick refresh)
            // Re-render list to show active state properly? simpler to just reload list
            loadChapterList();
        }

        window.addChapter = async () => {
            const title = prompt("ìƒˆ ì±•í„° ì œëª©:");
            if (!title) return;
            // Get current count for order
            const { data: chapters } = await getChapters(currentNovelId);
            const nextOrder = chapters ? chapters.length + 1 : 1;

            const { error } = await createChapter(currentNovelId, title, nextOrder);
            if (error) alert(error.message);
            else loadChapterList();
        };

        window.saveCurrent = async () => {
            if (!currentChapterId) return;
            const content = document.getElementById('editorArea').innerText;
            const btn = document.getElementById('saveBtn');

            btn.innerText = "ì €ì¥ì¤‘...";
            const { error } = await saveChapterContent(currentChapterId, content);

            if (error) {
                alert("ì €ì¥ ì‹¤íŒ¨: " + error.message);
                btn.innerText = "ì €ì¥";
            } else {
                btn.innerText = "ì €ì¥ë¨";
                setTimeout(() => btn.innerText = "ì €ì¥", 2000);
            }
        };

        window.toggleDark = () => {
            document.getElementById('editorArea').classList.toggle('dark-paper');
        }
    </script>
</head>

<body class="studio-body">
    <!-- Top Bar -->
    <div class="studio-header">
        <div class="studio-title">
            <a href="dashboard.html" style="color:#888; margin-right:8px;"><svg width="16" height="16" fill="none"
                    stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M19 12H5M12 19l-7-7 7-7" />
                </svg></a>
            <span id="novelTitle">ì œëª© ë¡œë”©ì¤‘...</span>
            <span style="color:#888; font-weight:400; font-size:12px; margin-left:8px;"> - ì§‘í•„ì‹¤</span>
        </div>
        <div class="studio-toolbar">
            <button class="tool-btn" onclick="toggleDark()"><svg width="14" height="14" fill="none"
                    stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
                </svg> ì•¼ê°„ëª¨ë“œ</button>
            <div style="width:1px; height:16px; background:#444; margin:0 8px;"></div>
            <button class="tool-btn primary" id="saveBtn" onclick="saveCurrent()"><svg width="14" height="14"
                    fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
                    <polyline points="17 21 17 13 7 13 7 21" />
                    <polyline points="7 3 7 8 15 8" />
                </svg> ì €ì¥</button>
            <button class="tool-btn" style="background:#4caf50; color:white;">ë°œí–‰</button>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="studio-layout">
        <!-- Left Panel: Chapter Tree -->
        <div class="panel-left">
            <div class="panel-header">
                <span>ëª©ì°¨</span>
                <span style="margin-left:auto; cursor:pointer;" onclick="addChapter()">+</span>
            </div>
            <div id="chapterList" class="panel-content">
                <!-- Dynamic List -->
            </div>
            <div style="padding:10px; border-top:1px solid #333; font-size:11px; color:#666;">
                ì„œë²„ ìë™ ì €ì¥ ì¼œì§
            </div>
        </div>

        <!-- Center: Editor -->
        <div class="panel-center">
            <div id="editorArea" class="novel-editor-area" contenteditable="true" style="outline:none;">

            </div>
        </div>

        <!-- Right Panel: Info (Mock for now, can be expanded to DB later) -->
        <div class="panel-right">
            <div class="panel-header">Context & Memo</div>
            <div class="panel-content">
                <div class="memo-card">
                    <div style="font-weight:700; margin-bottom:4px; color:#fff;">ğŸ’¡ ì‚¬ìš© íŒ</div>
                    ì¢Œì¸¡ ìƒë‹¨ì˜ + ë²„íŠ¼ì„ ëˆŒëŸ¬ ìƒˆ ì±•í„°ë¥¼ ìƒì„±í•˜ì„¸ìš”.<br>
                    ê¸€ì„ ì“°ê³  ìƒë‹¨ì˜ 'ì €ì¥' ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì„œë²„ì— ì €ì¥ë©ë‹ˆë‹¤.
                </div>
            </div>
        </div>
    </div>
</body>

</html>