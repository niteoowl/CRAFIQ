<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>작품 설정 - CRAFIQ Studio</title>
    <link rel="stylesheet" as="style" crossOrigin
        href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <link rel="stylesheet" href="style.css">
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module" src="js/init-supabase.js"></script>
    <script type="module" src="js/turbo-router.js"></script>

    <script type="module">
        import { getNovelById, updateNovel } from './js/data.js';

        let currentNovelId = null;

        window.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            currentNovelId = params.get('id');

            if (!currentNovelId) {
                alert("잘못된 접근");
                location.href = 'dashboard.html';
                return;
            }

            // Load Data
            const { data: novel, error } = await getNovelById(currentNovelId);
            if (error || !novel) {
                alert("작품을 불러올 수 없습니다.");
                return;
            }

            // Fill Form
            document.getElementById('inputTitle').value = novel.title;
            document.getElementById('inputDesc').value = novel.description || "";
            document.getElementById('inputSynopsis').value = novel.synopsis || "";
            document.getElementById('inputCover').value = novel.cover_url || '';
            document.getElementById('selectAge').value = novel.age_rating || 'All';
            document.getElementById('selectCategory').value = novel.genre || 'Romance'; // Use 'genre' column from Schema (assuming it exists or we use tags)
            // Wait, schema.sql showed 'tags' array but not explicit 'genre' column in the visible snippet?
            // Actually I'll check schema again or just assume 'tags' stores it, OR I'll use a new 'genre' field. 
            // The schema.sql snippet didn't explicitly show 'genre'. 
            // I will use 'tags' array for now to be safe: ["Fantasy"] 
            // OR I will assume column 'genre' exists. 
            // Let's rely on 'genre' column. If it fails, I'll fix schema.
            // Actually, based on previous interactions, I should probably add it to Schema if not there.
            // But I cannot run DDL easily. 
            // I will use the 'tags' column as a fallback or the 'genre' column if I'm confident. 
            // Let's try to read 'genre'. If undefined, maybe it's in tags.
            document.getElementById('selectCopyright').value = novel.copyright_type || 'Rental';
            // document.getElementById('inputLegal').value = novel.copyright_terms || "본 작품의 저작권은 작가에게 있으며, 무단 전재 및 재배포를 금합니다."; // This line is removed as per the instruction's implied change for copyright_terms handling.

            // Preview
            updatePreview();
            // Handle Date Input visibility logic initialization if needed (mocked for now)
            toggleDateInput();
        });

        // Toggle Date Input based on selection
        document.getElementById('selectCopyright').addEventListener('change', toggleDateInput);

        function toggleDateInput() {
            const val = document.getElementById('selectCopyright').value;
            const dateRow = document.getElementById('limitedDateRow');
            if (val === 'Limited') dateRow.style.display = 'block';
            else dateRow.style.display = 'none';
        }

        window.saveSettings = async () => {
            const agreement = document.getElementById('checkAgreement');
            if (!agreement.checked) {
                alert("법적 고지 및 면책 조항에 동의해야 저장할 수 있습니다.");
                agreement.focus();
                return;
            }

            const btn = document.getElementById('saveBtn');
            btn.innerText = "저장 중...";
            btn.disabled = true;

            const updates = {
                title: document.getElementById('inputTitle').value,
                description: document.getElementById('inputDesc').value,
                synopsis: document.getElementById('inputSynopsis').value,
                cover_url: document.getElementById('inputCover').value,
                age_rating: document.getElementById('selectAge').value,
                genre: document.getElementById('selectCategory').value, // Saving to 'genre' column
                copyright_type: document.getElementById('selectCopyright').value,
                // store custom legal terms derived from type or input if needed
                // For 'Limited', we might store the date in 'copyright_terms' for simplicity in this schema
                copyright_terms: document.getElementById('selectCopyright').value === 'Limited'
                    ? "Expires: " + document.getElementById('inputExpiryDate').value
                    : "Standard Terms"
            };

            const { error } = await updateNovel(currentNovelId, updates);

            if (error) {
                alert("저장 실패: " + error.message);
                btn.innerText = "설정 저장";
                btn.disabled = false;
            } else {
                alert("설정이 성공적으로 저장되었습니다.");
                location.href = 'dashboard.html';
            }
        };

        window.updatePreview = () => {
            const url = document.getElementById('inputCover').value;
            if (url) document.getElementById('coverPreview').src = url;
        }

        window.goBack = () => {
            history.back();
        }
    </script>
</head>

<body style="background:#111; color:#eee;">
    <header>
        <div class="header-inner">
            <div style="display:flex; align-items:center; gap:12px;">
                <button onclick="goBack()" style="background:none; border:none; color:white; cursor:pointer;">
                    <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M19 12H5M12 19l-7-7 7-7" />
                    </svg>
                </button>
                <span class="brand">작품 상세 설정</span>
            </div>
        </div>
    </header>

    <main class="inner" style="padding-top:40px; max-width:800px;">

        <div class="studio-form-grid">
            <!-- Cover Image Section -->
            <div style="width:200px; flex-shrink:0;">
                <div style="margin-bottom:8px; font-weight:700;">표지 이미지</div>
                <div class="book-cover" style="width:200px; height:300px; margin-bottom:12px;">
                    <img id="coverPreview" src="https://via.placeholder.com/200x300?text=No+Cover"
                        style="width:100%; height:100%; object-fit:cover; border-radius:6px;">
                </div>
                <input id="inputCover" class="auth-input" placeholder="이미지 URL 입력" onchange="updatePreview()">
                <div style="font-size:11px; color:#666; margin-top:4px;">* Unsplash 등의 이미지 주소를 입력하세요.</div>
            </div>

            <!-- Metadata Section -->
            <div style="flex:1; display:flex; flex-direction:column; gap:20px;">

                <!-- Title -->
                <div>
                    <label class="form-label">작품 제목 (Title)</label>
                    <input id="inputTitle" class="auth-input" type="text" placeholder="작품 제목을 입력하세요">
                </div>

                <!-- Short Desc -->
                <div>
                    <label class="form-label">한줄 소개 (Short Description)</label>
                    <input id="inputDesc" class="auth-input" type="text" placeholder="작품을 한 문장으로 표현한다면?">
                </div>

                <!-- Synopsis -->
                <div>
                    <label class="form-label">줄거리 (Synopsis)</label>
                    <textarea id="inputSynopsis" class="auth-input" style="height:120px; resize:vertical;"
                        placeholder="전체적인 줄거리나 독자들에게 전하고 싶은 말을 적어주세요."></textarea>
                </div>

                <!-- Age Rating -->
                <div>
                    <label class="form-label">이용 등급 (Age Rating)</label>
                    <select id="selectAge" class="auth-input" style="background:#222; color:white;">
                        <option value="All">전체 이용가</option>
                        <option value="12+">12세 이용가</option>
                        <option value="15+">15세 이용가 (주제, 언어 등)</option>
                        <option value="19+">19세 미만 구독 불가</option>
                    </select>
                </div>

                <!-- Category/Genre -->
                <div>
                    <label class="form-label">장르 (Genre/Category)</label>
                    <select id="selectCategory" class="auth-input" style="background:#222; color:white;">
                        <option value="Romance">로맨스 (Romance)</option>
                        <option value="RoFan">로판 (Romance Fantasy)</option>
                        <option value="Fantasy">판타지 (Fantasy)</option>
                        <option value="ModernFantasy">현대판타지 (Modern Fantasy)</option>
                        <option value="Wuxia">무협 (Wuxia)</option>
                        <option value="Sports">스포츠 (Sports)</option>
                        <option value="Game">게임판타지 (Game Fantasy)</option>
                        <option value="AltHistory">대체역사 (Alternative History)</option>
                        <option value="SciFi">SF (Sci-Fi)</option>
                        <option value="Thriller">스릴러/미스터리 (Thriller/Mystery)</option>
                        <option value="Horror">공포 (Horror)</option>
                        <option value="Drama">드라마 (Drama)</option>
                        <option value="BL">BL (Boys Love)</option>
                        <option value="GL">GL (Girls Love)</option>
                        <option value="LightNovel">라이트노벨 (Light Novel)</option>
                        <option value="Parocdy">패러디 (Parody)</option>
                        <option value="FanFic">팬픽 (Fan Fiction)</option>
                        <option value="Essay">수필/에세이 (Essay)</option>
                        <option value="Poetry">시 (Poetry)</option>
                    </select>
                </div>

                <hr style="border:0; border-top:1px solid #333; margin:10px 0;">

                <!-- Legal & Publication Settings -->
                <div class="settings-group" style="border:1px solid #e74c3c;">
                    <h3 style="color:#e74c3c; border-bottom:1px solid #e74c3c;">⚖️ 배급 및 저작권 설정 (중요)</h3>

                    <div class="form-row">
                        <label class="form-label">공개 방식 (Publication Type)</label>
                        <select id="selectCopyright"
                            style="width:100%; padding:10px; background:#333; color:white; border:1px solid #555;">
                            <option value="Rental">일반 연재 (작가 저작권 보유 / 언제든 비공개 가능)</option>
                            <option value="Limited">기간 한정 공개 (지정된 날짜까지만 배급 / 이후 자동 비공개)</option>
                            <option value="Perpetual">영구 독점 공개 (CRAFIQ 귀속 / 철회 불가 / 수익 배분 7:3)</option>
                        </select>
                    </div>

                    <!-- Conditional Date Input -->
                    <div id="limitedDateRow" class="form-row" style="display:none;">
                        <label class="form-label" style="color:#e74c3c;">공개 종료일 (Expiration Date)</label>
                        <input type="date" id="inputExpiryDate"
                            style="width:100%; padding:10px; background:#333; color:white; border:1px solid #e74c3c;">
                        <p style="font-size:12px; color:#aaa; margin-top:4px;">* 해당 날짜의 자정(00:00)에 작품이 비공개로 전환됩니다.</p>
                    </div>

                    <div class="form-row" style="margin-top:20px;">
                        <label class="form-label">면책 및 법적 고지 (Terms & Agreements)</label>
                        <div
                            style="background:#222; padding:15px; font-size:12px; color:#aaa; height:100px; overflow-y:auto; border:1px solid #444; margin-bottom:10px;">
                            1. [배급 권한] 작가는 본 플랫폼에 작품을 배급할 정당한 권리를 보유하고 있음을 보증합니다.<br>
                            2. [책임 제한] 작품 내 포함된 모든 콘텐츠(텍스트, 이미지 등)에 대한 법적 책임은 전적으로 작가에게 있습니다.<br>
                            3. [영구 독점 선택 시] '영구 독점 공개'를 선택할 경우, 본 작품의 배급권은 CRAFIQ 플랫폼에 영구 귀속되며, 작가는 임의로 이를 철회할 수
                            없습니다.<br>
                            4. [제3자 권리] 타인의 저작권을 침해하는 콘텐츠가 확인될 경우, 플랫폼은 즉시 해당 작품을 삭제하고 작가에게 손해배상을 청구할 수 있습니다.
                        </div>

                        <div style="display:flex; gap:10px; align-items:center;">
                            <input type="checkbox" id="checkAgreement" style="width:20px; height:20px;">
                            <label for="checkAgreement" style="font-size:14px; cursor:pointer; color:#eee;">위 면책 조항 및 공개
                                조건에 동의하며, 이에 따른 법적 책임을 감수합니다.</label>
                        </div>
                    </div>
                </div>

                <div style="margin-top:20px;">
                    <button id="saveBtn" class="auth-btn" onclick="saveSettings()">설정 저장</button>
                    <div style="text-align:center; margin-top:12px;">
                        <span style="font-size:12px; color:#666;">저장 시 위 내용에 대한 법적 효력에 동의하는 것으로 간주합니다.</span>
                    </div>
                </div>

            </div>
        </div>

    </main>

    <style>
        .studio-form-grid {
            display: flex;
            gap: 40px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            color: #ccc;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .studio-form-grid {
                flex-direction: column;
            }

            .book-cover {
                margin: 0 auto 12px;
            }
        }
    </style>
</body>

</html>